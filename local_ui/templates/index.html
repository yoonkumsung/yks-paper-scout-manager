<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Scout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ps-bg: #f8fafc;
            --ps-card-bg: #ffffff;
            --ps-card-border: #e2e8f0;
            --ps-card-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            --ps-card-radius: 12px;
            --ps-primary: #4f46e5;
            --ps-primary-hover: #4338ca;
            --ps-primary-light: #6366f1;
            --ps-primary-bg: rgba(79,70,229,0.08);
            --ps-text: #1e293b;
            --ps-text-secondary: #64748b;
            --ps-text-muted: #94a3b8;
            --ps-border: #e2e8f0;
            --ps-success: #10b981;
            --ps-danger: #ef4444;
            --ps-warning: #f59e0b;
            --ps-nav-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { padding-top: 64px; background: var(--ps-bg); color: var(--ps-text); }
        .tab-content { padding: 24px 0; }

        /* Navbar */
        .navbar { background: var(--ps-nav-bg) !important; border-bottom: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); }
        .navbar-brand { font-weight: 700; font-size: 1.15rem; letter-spacing: -0.02em; }
        .navbar-text { font-size: 0.85rem; color: rgba(255,255,255,0.6) !important; }

        /* Tabs */
        .nav-tabs { border-bottom: 2px solid var(--ps-border); gap: 4px; }
        .nav-tabs .nav-link {
            border: none; border-radius: 8px 8px 0 0; padding: 12px 24px;
            font-weight: 600; font-size: 1.05rem; color: var(--ps-text-secondary);
            transition: all 0.2s ease; position: relative;
        }
        .nav-tabs .nav-link:hover { color: var(--ps-primary); background: var(--ps-primary-bg); }
        .nav-tabs .nav-link.active {
            color: var(--ps-primary); background: transparent; border: none;
            box-shadow: inset 0 -2px 0 var(--ps-primary);
        }

        /* Cards */
        .card {
            border: 1px solid var(--ps-card-border); border-radius: var(--ps-card-radius);
            box-shadow: var(--ps-card-shadow); background: var(--ps-card-bg);
            transition: box-shadow 0.2s ease;
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .card-header {
            background: var(--ps-card-bg); border-bottom: 1px solid var(--ps-border);
            padding: 16px 20px; border-radius: var(--ps-card-radius) var(--ps-card-radius) 0 0 !important;
        }
        .card-header h5 { font-weight: 600; font-size: 0.95rem; color: var(--ps-text); }
        .card-body { padding: 20px; }

        /* Buttons */
        .btn-primary {
            background: var(--ps-primary); border-color: var(--ps-primary);
            border-radius: 8px; font-weight: 500; font-size: 0.875rem;
            padding: 8px 16px; transition: all 0.15s ease;
        }
        .btn-primary:hover { background: var(--ps-primary-hover); border-color: var(--ps-primary-hover); transform: translateY(-1px); }
        .btn-secondary { border-radius: 8px; font-weight: 500; font-size: 0.875rem; padding: 8px 16px; }
        .btn-success {
            background: var(--ps-success); border-color: var(--ps-success);
            border-radius: 8px; font-weight: 500; font-size: 0.875rem; padding: 8px 16px;
        }
        .btn-success:hover { background: #059669; border-color: #059669; transform: translateY(-1px); }
        .btn-outline-primary { border-radius: 8px; font-weight: 500; font-size: 0.875rem; color: var(--ps-primary); border-color: var(--ps-primary); }
        .btn-outline-primary:hover { background: var(--ps-primary); border-color: var(--ps-primary); }
        .btn-outline-secondary { border-radius: 8px; font-weight: 500; font-size: 0.875rem; }
        .btn-outline-danger { border-radius: 8px; font-weight: 500; font-size: 0.875rem; }
        .btn-sm { padding: 5px 18px; font-size: 0.8rem; }
        .btn-lg { padding: 12px 32px; font-size: 1rem; border-radius: 10px; }

        /* Form */
        .form-control, .form-select {
            border-radius: 8px; border: 1px solid var(--ps-border);
            font-size: 0.875rem; padding: 8px 12px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--ps-primary-light); box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
        }
        .form-label { font-weight: 500; font-size: 0.875rem; color: var(--ps-text); }

        /* Headings */
        h2 { font-weight: 700; font-size: 1.5rem; letter-spacing: -0.02em; margin-bottom: 20px; color: var(--ps-text); }

        /* Settings sections */
        .settings-group-header { padding: 6px 0; margin: 24px 0 8px; border-bottom: 2px solid var(--ps-primary); }
        .settings-group-header:first-child { margin-top: 0; }
        .settings-group-header strong { font-size: 0.9rem; color: var(--ps-text); letter-spacing: -0.01em; }
        .settings-group-header span { display: block; font-size: 0.78rem; color: var(--ps-text-muted); margin-top: 3px; }
        .settings-section { border: 1px solid var(--ps-border); border-radius: var(--ps-card-radius); margin-bottom: 6px; overflow: hidden; }
        .settings-section .section-header {
            background: var(--ps-bg); padding: 10px 14px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.15s ease;
        }
        .settings-section .section-header:hover { background: #eef2ff; }
        .settings-section .section-body { padding: 14px; display: none; }
        .settings-section.open .section-body { display: block; }
        .settings-section.open .section-header { border-bottom: 1px solid var(--ps-border); }
        .settings-section .section-header .arrow { transition: transform 0.2s; color: var(--ps-text-muted); font-size: 0.75rem; margin-left: auto; flex-shrink: 0; }
        .settings-section.open .section-header .arrow { transform: rotate(90deg); }
        .settings-section .section-header strong { font-size: 0.875rem; }
        .settings-section .section-desc { font-size: 0.75rem; color: var(--ps-text-muted); margin-left: 0.5rem; }

        .nested-group { background: var(--ps-bg); border: 1px solid var(--ps-border); border-radius: 8px; padding: 12px 14px; margin-bottom: 8px; }
        .nested-group .nested-group { background: #fff; border: 1px solid #eef2ff; }
        .nested-group h6 { color: var(--ps-text); font-size: 0.82rem; font-weight: 600; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--ps-border); }
        .nested-group h6 .nested-hint { font-weight: 400; color: var(--ps-text-muted); font-size: 0.75rem; margin-left: 6px; }
        .form-check.setting-bool { margin-bottom: 0.5rem; }
        .form-check.setting-bool .field-hint { display: inline; margin-left: 0.5rem; margin-top: 0; }
        .settings-section .mb-2 { margin-bottom: 6px !important; }
        .settings-section .form-label, .settings-section .form-check-label { font-size: 0.82rem; margin-bottom: 2px; }
        .settings-section .form-control-sm, .settings-section .form-select-sm { font-size: 0.82rem; padding: 4px 8px; }

        /* Setup */
        .setup-key-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .setup-key-row label { min-width: 200px; font-weight: 500; font-size: 0.875rem; }
        .setup-key-row .input-group { flex: 1; }
        .step-result { padding: 0.5rem 0; border-bottom: 1px solid var(--ps-border); }
        .step-result:last-child { border-bottom: none; }

        /* Setup card enhancements */
        .setup-card { border-left: 4px solid var(--ps-primary); }
        .setup-card.required { border-left-color: var(--ps-primary); }
        .setup-card.optional { border-left-color: #94a3b8; }
        .setup-card .card-benefit { background: #f0fdf4; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.85rem; color: #166534; }
        .setup-card .card-no-benefit { background: #fef3c7; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.85rem; color: #92400e; }
        .setup-field { margin-bottom: 1rem; }
        .setup-field label { font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 4px; }
        .setup-field .field-help { font-size: 0.8rem; color: var(--ps-text-muted); margin-top: 4px; }
        .setup-field .field-help a { color: var(--ps-primary); text-decoration: none; }
        .setup-field .field-help a:hover { text-decoration: underline; }
        .setup-field .validation-badge { font-size: 0.75rem; margin-left: 8px; }
        .progress-bar-setup { height: 8px; border-radius: 4px; background: #e2e8f0; overflow: hidden; margin-bottom: 8px; }
        .progress-bar-setup .fill { height: 100%; background: var(--ps-success); border-radius: 4px; transition: width 0.3s ease; }
        .setup-progress-text { font-size: 0.85rem; color: var(--ps-text-secondary); margin-bottom: 16px; }
        .field-hint { font-size: 0.75rem; color: var(--ps-text-muted); margin-left: 0.4rem; display: inline; line-height: 1.3; }
        .tab-subtitle { color: var(--ps-text-secondary); font-size: 0.9rem; margin: 0 0 20px 0; }
        .tab-pane { padding-top: 0; }
        .setup-subgroup { background: var(--ps-bg); border: 1px solid var(--ps-border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .setup-subgroup-title { font-weight: 600; font-size: 0.9rem; color: var(--ps-text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .setup-subgroup-title .subgroup-icon { font-size: 1.1rem; }

        /* Modal */
        .modal-content { border-radius: var(--ps-card-radius); border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .modal-header { border-bottom: 1px solid var(--ps-border); padding: 16px 20px; }
        .modal-body { padding: 20px; }
        .modal-footer { border-top: 1px solid var(--ps-border); padding: 12px 20px; }
        #addTopicModal .modal-body { max-height: 75vh; overflow-y: auto; }
        #addTopicForm input::placeholder, #addTopicForm textarea::placeholder { color: #c8c8c8; }

        /* Badges */
        .badge { font-weight: 500; font-size: 0.75rem; border-radius: 6px; padding: 4px 8px; }

        /* Tables */
        .table { font-size: 0.875rem; }
        .table th { font-weight: 600; color: var(--ps-text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.03em; }

        /* List group */
        .list-group-item {
            border: 1px solid var(--ps-border); border-radius: var(--ps-card-radius) !important;
            margin-bottom: 8px; padding: 16px 20px; transition: box-shadow 0.15s ease;
        }
        .list-group-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .list-group-item h5 { font-weight: 600; font-size: 1rem; }

        /* Info link */
        .info-link { color: var(--ps-primary); text-decoration: none; font-size: 0.85rem; font-weight: 500; cursor: pointer; }
        .info-link:hover { text-decoration: underline; color: var(--ps-primary-hover); }

        /* Animations */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .progress-pulsing .progress-msg-text { animation: progressPulse 1.5s ease-in-out infinite; }
        .progress-pulsing .progress-bar-fill { animation: progressPulse 1.5s ease-in-out infinite; }
        .progress-elapsed { color: #6b7280; font-family: 'SF Mono', monospace; font-size: 0.75rem; margin-left: 8px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">YKS Paper Scout</a>
            <span class="navbar-text">&mdash; &nbsp;로컬 관리 UI</span>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex align-items-end justify-content-between">
            <ul class="nav nav-tabs mb-0" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup" type="button" role="tab">등록</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button" role="tab">토픽</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab">논문 수집</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">설정</button>
                </li>
            </ul>
            <div class="d-flex gap-2 pb-1">
                <button class="btn btn-sm btn-primary" id="globalSaveBtn" onclick="globalSave()">저장</button>
                <button class="btn btn-sm btn-outline-success" id="globalDeployBtn" onclick="deployToGitHub()">GitHub에 배포</button>
            </div>
        </div>

        <div class="tab-content" id="mainTabsContent">
            <!-- Setup Tab -->
            <div class="tab-pane fade" id="setup" role="tabpanel">
                <p class="tab-subtitle">Paper Scout를 시작하기 위해 필요한 서비스 인증 정보를 등록합니다.</p>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="setup-progress-text" id="setupProgressText">설정 완료율 확인 중...</span>
                    </div>
                    <div class="progress-bar-setup">
                        <div class="fill" id="setupProgressFill" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Card 1: LLM API (Required) -->
                <div class="card mb-3 setup-card required">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">AI 모델 API <span class="badge bg-danger ms-2">필수</span></h5>
                        <span id="setupBadge_OPENROUTER_API_KEY" class="badge bg-secondary">확인 중...</span>
                    </div>
                    <div class="card-body">
                        <div class="card-benefit">논문 키워드 생성, 관련성 평가, 요약을 AI가 자동으로 처리합니다.</div>
                        <div class="setup-field">
                            <label for="setupKey_OPENROUTER_API_KEY">OpenRouter API 키</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="setupKey_OPENROUTER_API_KEY" placeholder="sk-or-로 시작하는 API 키" data-validate="openrouter">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                            </div>
                            <div class="field-help">
                                <a href="https://openrouter.ai/keys" target="_blank">OpenRouter에서 무료 키 받기 &rarr;</a>
                            </div>
                        </div>
                        <small class="text-muted">기존 값을 유지하려면 빈칸으로 두세요.</small>
                    </div>
                </div>

                <!-- Card 2: Notifications (Optional) -->
                <div class="card mb-3 setup-card optional">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">알림 채널 <span class="badge bg-secondary ms-2">선택</span></h5>
                        <span id="setupBadge_notifications" class="badge bg-secondary">확인 중...</span>
                    </div>
                    <div class="card-body">
                        <div class="card-benefit">등록하면 논문 수집이 시작/완료될 때 Telegram이나 Discord로 알림을 받을 수 있습니다.</div>
                        <div class="card-no-benefit">미등록 시: 알림 없이 웹 UI에서 직접 결과를 확인해야 합니다.</div>

                        <!-- Telegram subgroup -->
                        <div class="setup-subgroup">
                            <div class="setup-subgroup-title">
                                <span class="subgroup-icon">&#9992;</span> Telegram
                            </div>
                            <div class="setup-field">
                                <label for="setupKey_TELEGRAM_BOT_TOKEN">Bot Token</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="setupKey_TELEGRAM_BOT_TOKEN" placeholder="123456789:ABC-DEF 형식" data-validate="telegram_token">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                                </div>
                                <div class="field-help">
                                    <a href="https://core.telegram.org/bots#botfather" target="_blank">@BotFather에게 /newbot으로 생성 &rarr;</a>
                                </div>
                            </div>
                            <div class="setup-field mb-0">
                                <label for="setupKey_TELEGRAM_CHAT_ID">Chat ID</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="setupKey_TELEGRAM_CHAT_ID" placeholder="숫자 형식의 채팅 ID" data-validate="telegram_chat">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                                </div>
                                <div class="field-help">
                                    <a href="https://t.me/userinfobot" target="_blank">@userinfobot에게 메시지를 보내면 확인 &rarr;</a>
                                </div>
                            </div>
                        </div>

                        <!-- Discord subgroup -->
                        <div class="setup-subgroup">
                            <div class="setup-subgroup-title">
                                <span class="subgroup-icon">&#128172;</span> Discord
                            </div>
                            <div class="setup-field mb-0">
                                <label for="setupKey_DISCORD_WEBHOOK_URL">Webhook URL</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="setupKey_DISCORD_WEBHOOK_URL" placeholder="https://discord.com/api/webhooks/..." data-validate="discord">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                                </div>
                                <div class="field-help">
                                    <a href="https://support.discord.com/hc/en-us/articles/228383668" target="_blank">Discord Webhook 만들기 &rarr;</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 3: GitHub (Optional) -->
                <div class="card mb-3 setup-card optional">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">GitHub 연동 <span class="badge bg-secondary ms-2">선택</span></h5>
                        <span id="setupBadge_GITHUB_TOKEN" class="badge bg-secondary">확인 중...</span>
                    </div>
                    <div class="card-body">
                        <div class="card-benefit">등록하면 매일 자동으로 논문을 수집하고, GitHub Pages에 리포트를 배포할 수 있습니다.</div>
                        <div class="card-no-benefit">미등록 시: 수동으로 [논문 수집] 탭에서 실행해야 하고, 리포트는 로컬에서만 볼 수 있습니다.</div>
                        <div class="setup-field">
                            <label for="setupKey_GITHUB_TOKEN">GitHub Personal Access Token</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="setupKey_GITHUB_TOKEN" placeholder="ghp_ 또는 github_pat_으로 시작" data-validate="github">
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                            </div>
                            <div class="field-help">
                                <a href="https://github.com/settings/tokens/new" target="_blank">Personal Access Token 만들기 &rarr;</a>
                            </div>
                        </div>
                        <div id="setupRepoInfo" class="mb-2">
                            <span class="text-muted" style="font-size: 0.85rem;">저장소 감지 중...</span>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pushSecretsCheck" checked>
                            <label class="form-check-label" for="pushSecretsCheck">
                                GitHub Actions 시크릿에도 자동 반영
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Card 4: Supabase (Optional) -->
                <div class="card mb-3 setup-card optional">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Supabase 연동 <span class="badge bg-secondary ms-2">선택</span></h5>
                        <span id="setupBadge_SUPABASE_DB_URL" class="badge bg-secondary">확인 중...</span>
                    </div>
                    <div class="card-body">
                        <div class="card-benefit">등록하면 로컬과 GitHub Actions가 동일한 DB를 공유하고, 여러 기기에서 읽음 상태를 동기화합니다.</div>
                        <div class="card-no-benefit">미등록 시: 로컬 SQLite DB를 사용합니다. 기기별로 데이터가 분리되어 이력이 공유되지 않습니다.</div>

                        <!-- DB Connection subgroup -->
                        <div class="setup-subgroup">
                            <div class="setup-subgroup-title">
                                <span class="subgroup-icon">&#128451;</span> DB 연결
                            </div>
                            <div class="setup-field mb-0">
                                <label for="setupKey_SUPABASE_DB_URL">Connection String</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="setupKey_SUPABASE_DB_URL" placeholder="postgresql://postgres:비밀번호@db.xxx.supabase.co:5432/postgres" data-validate="supabase_db">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                                </div>
                                <div class="field-help">
                                    <a href="https://supabase.com/dashboard/project/_/settings/database" target="_blank">Supabase &gt; Settings &gt; Database &gt; Connection string &rarr;</a>
                                </div>
                            </div>
                        </div>

                        <!-- API / Read Sync subgroup -->
                        <div class="setup-subgroup">
                            <div class="setup-subgroup-title">
                                <span class="subgroup-icon">&#128279;</span> 읽음 동기화 API
                            </div>
                            <div class="setup-field">
                                <label for="setupSupabaseUrl">Project URL</label>
                                <input type="text" class="form-control" id="setupSupabaseUrl" placeholder="https://xxx.supabase.co" data-validate="supabase_url">
                                <div class="field-help">
                                    <a href="https://supabase.com/dashboard/project/_/settings/api" target="_blank">Supabase &gt; Settings &gt; API &gt; Project URL &rarr;</a>
                                </div>
                            </div>
                            <div class="setup-field mb-0">
                                <label for="setupSupabaseAnonKey">Anon Public Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="setupSupabaseAnonKey" placeholder="eyJ로 시작하는 anon public 키" data-validate="supabase_anon">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="togglePassword(this)">보기</button>
                                </div>
                                <div class="field-help">
                                    <a href="https://supabase.com/dashboard/project/_/settings/api" target="_blank">Supabase &gt; Settings &gt; API &gt; anon public &rarr;</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="deployResults" class="mt-3" style="display: none;"></div>
            </div>

            <!-- Topics Tab -->
            <div class="tab-pane fade show active" id="topics" role="tabpanel">
                <p class="tab-subtitle">추적하고 싶은 연구 분야를 등록하세요. 토픽별로 arXiv 카테고리와 알림을 설정할 수 있습니다.</p>
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-sm btn-primary" id="addTopicBtn">토픽 추가</button>
                    <button class="btn btn-sm btn-secondary" id="refreshTopicsBtn">새로고침</button>
                </div>
                <div id="topicsList">
                    <div class="text-center text-muted">토픽 로딩 중...</div>
                </div>

                <!-- Add Topic Modal -->
                <div class="modal fade" id="addTopicModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">새 토픽 추가</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addTopicForm">
                                    <div class="mb-3">
                                        <label class="form-label">슬러그 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="slug" required placeholder="llm-research">
                                        <small class="text-muted">토픽 고유 ID. 영문 소문자와 하이픈(-)만 사용. 내부적으로 토픽을 구분하는 데 쓰입니다.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">이름 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="name" required placeholder="LLM 최신 연구">
                                        <small class="text-muted">리포트와 알림에 표시되는 이름입니다.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">설명 <span class="text-danger">*</span></label>
                                        <textarea class="form-control" name="description" required rows="3" placeholder="대규모 언어 모델(LLM) 학습 및 추론 최적화, RAG, 프롬프트 엔지니어링, RLHF, 파인튜닝 기법"></textarea>
                                        <small class="text-muted">추적하고 싶은 연구 분야를 설명해 주세요. AI가 이 설명을 바탕으로 검색 키워드를 자동 생성합니다.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">arXiv Categories <span class="text-danger">*</span></label>
                                        <small class="text-muted d-block mb-2">논문을 검색할 arXiv 카테고리를 선택하세요. 여러 개 선택 가능합니다.</small>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="document.querySelectorAll('.cat-check').forEach(c=>{c.checked=true});updateCatDisplay()">전체 선택</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.cat-check').forEach(c=>{c.checked=false});updateCatDisplay()">전체 해제</button>
                                            <button type="button" class="btn btn-sm btn-success" id="aiRecommendBtn" onclick="aiRecommendCategories()">AI 추천</button>
                                            <span id="aiRecommendSpinner" class="spinner-border spinner-border-sm text-success ms-1 d-none" role="status"></span>
                                        </div>
                                        <div id="catWarning" class="alert alert-warning py-1 px-2 small d-none mb-2">
                                            카테고리를 10개 이하로 선택하는 것을 권장합니다. 너무 많으면 키워드 생성 품질이 저하될 수 있습니다.
                                        </div>
                                        <div id="categoryPicker" style="border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.75rem;">

                                            <div class="mb-1"><strong class="text-muted small">Computer Science - AI / ML</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.AI" id="cat-cs-AI"><label class="form-check-label small" for="cat-cs-AI">cs.AI - 인공지능</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.LG" id="cat-cs-LG"><label class="form-check-label small" for="cat-cs-LG">cs.LG - 머신러닝</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CL" id="cat-cs-CL"><label class="form-check-label small" for="cat-cs-CL">cs.CL - 자연어처리 (NLP)</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CV" id="cat-cs-CV"><label class="form-check-label small" for="cat-cs-CV">cs.CV - 컴퓨터 비전</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.NE" id="cat-cs-NE"><label class="form-check-label small" for="cat-cs-NE">cs.NE - 신경망 및 진화 컴퓨팅</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.IR" id="cat-cs-IR"><label class="form-check-label small" for="cat-cs-IR">cs.IR - 정보 검색</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.MA" id="cat-cs-MA"><label class="form-check-label small" for="cat-cs-MA">cs.MA - 멀티에이전트 시스템</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.RO" id="cat-cs-RO"><label class="form-check-label small" for="cat-cs-RO">cs.RO - 로보틱스</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Computer Science - Systems / Software</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.SE" id="cat-cs-SE"><label class="form-check-label small" for="cat-cs-SE">cs.SE - 소프트웨어 공학</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.DC" id="cat-cs-DC"><label class="form-check-label small" for="cat-cs-DC">cs.DC - 분산/병렬/클러스터 컴퓨팅</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.DB" id="cat-cs-DB"><label class="form-check-label small" for="cat-cs-DB">cs.DB - 데이터베이스</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.OS" id="cat-cs-OS"><label class="form-check-label small" for="cat-cs-OS">cs.OS - 운영체제</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.PL" id="cat-cs-PL"><label class="form-check-label small" for="cat-cs-PL">cs.PL - 프로그래밍 언어</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.AR" id="cat-cs-AR"><label class="form-check-label small" for="cat-cs-AR">cs.AR - 하드웨어 아키텍처</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.NI" id="cat-cs-NI"><label class="form-check-label small" for="cat-cs-NI">cs.NI - 네트워킹/인터넷 아키텍처</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.PF" id="cat-cs-PF"><label class="form-check-label small" for="cat-cs-PF">cs.PF - 성능</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Computer Science - Theory / Math</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.DS" id="cat-cs-DS"><label class="form-check-label small" for="cat-cs-DS">cs.DS - 자료구조 및 알고리즘</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CC" id="cat-cs-CC"><label class="form-check-label small" for="cat-cs-CC">cs.CC - 계산 복잡도</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.LO" id="cat-cs-LO"><label class="form-check-label small" for="cat-cs-LO">cs.LO - 논리학</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.FL" id="cat-cs-FL"><label class="form-check-label small" for="cat-cs-FL">cs.FL - 형식 언어 및 오토마타</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.DM" id="cat-cs-DM"><label class="form-check-label small" for="cat-cs-DM">cs.DM - 이산 수학</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.IT" id="cat-cs-IT"><label class="form-check-label small" for="cat-cs-IT">cs.IT - 정보 이론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.NA" id="cat-cs-NA"><label class="form-check-label small" for="cat-cs-NA">cs.NA - 수치 해석</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.SC" id="cat-cs-SC"><label class="form-check-label small" for="cat-cs-SC">cs.SC - 기호 계산</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.GT" id="cat-cs-GT"><label class="form-check-label small" for="cat-cs-GT">cs.GT - 게임 이론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CG" id="cat-cs-CG"><label class="form-check-label small" for="cat-cs-CG">cs.CG - 계산 기하학</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Computer Science - Applications</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CR" id="cat-cs-CR"><label class="form-check-label small" for="cat-cs-CR">cs.CR - 암호학 및 보안</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.HC" id="cat-cs-HC"><label class="form-check-label small" for="cat-cs-HC">cs.HC - 인간-컴퓨터 상호작용</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CY" id="cat-cs-CY"><label class="form-check-label small" for="cat-cs-CY">cs.CY - 컴퓨터와 사회</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.CE" id="cat-cs-CE"><label class="form-check-label small" for="cat-cs-CE">cs.CE - 전산 공학/금융/과학</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.GR" id="cat-cs-GR"><label class="form-check-label small" for="cat-cs-GR">cs.GR - 그래픽스</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.MM" id="cat-cs-MM"><label class="form-check-label small" for="cat-cs-MM">cs.MM - 멀티미디어</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.SD" id="cat-cs-SD"><label class="form-check-label small" for="cat-cs-SD">cs.SD - 사운드</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.SI" id="cat-cs-SI"><label class="form-check-label small" for="cat-cs-SI">cs.SI - 소셜/정보 네트워크</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.DL" id="cat-cs-DL"><label class="form-check-label small" for="cat-cs-DL">cs.DL - 디지털 라이브러리</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.ET" id="cat-cs-ET"><label class="form-check-label small" for="cat-cs-ET">cs.ET - 신흥 기술</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.MS" id="cat-cs-MS"><label class="form-check-label small" for="cat-cs-MS">cs.MS - 수학 소프트웨어</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.GL" id="cat-cs-GL"><label class="form-check-label small" for="cat-cs-GL">cs.GL - 일반 문헌</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.OH" id="cat-cs-OH"><label class="form-check-label small" for="cat-cs-OH">cs.OH - 기타</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="cs.SY" id="cat-cs-SY"><label class="form-check-label small" for="cat-cs-SY">cs.SY - 시스템 및 제어</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Statistics</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="stat.ML" id="cat-stat-ML"><label class="form-check-label small" for="cat-stat-ML">stat.ML - 머신러닝 (통계)</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="stat.ME" id="cat-stat-ME"><label class="form-check-label small" for="cat-stat-ME">stat.ME - 통계 방법론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="stat.TH" id="cat-stat-TH"><label class="form-check-label small" for="cat-stat-TH">stat.TH - 통계 이론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="stat.AP" id="cat-stat-AP"><label class="form-check-label small" for="cat-stat-AP">stat.AP - 응용 통계</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="stat.CO" id="cat-stat-CO"><label class="form-check-label small" for="cat-stat-CO">stat.CO - 전산 통계</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Electrical Engineering / Signal Processing</strong></div>
                                            <div class="row row-cols-2 g-0 mb-2">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="eess.SP" id="cat-eess-SP"><label class="form-check-label small" for="cat-eess-SP">eess.SP - 신호 처리</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="eess.AS" id="cat-eess-AS"><label class="form-check-label small" for="cat-eess-AS">eess.AS - 오디오 및 음성 처리</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="eess.IV" id="cat-eess-IV"><label class="form-check-label small" for="cat-eess-IV">eess.IV - 이미지/비디오 처리</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="eess.SY" id="cat-eess-SY"><label class="form-check-label small" for="cat-eess-SY">eess.SY - 시스템 및 제어</label></div></div>
                                            </div>

                                            <div class="mb-1"><strong class="text-muted small">Mathematics / Quantitative / Other</strong></div>
                                            <div class="row row-cols-2 g-0">
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="math.OC" id="cat-math-OC"><label class="form-check-label small" for="cat-math-OC">math.OC - 최적화 및 제어</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="math.ST" id="cat-math-ST"><label class="form-check-label small" for="cat-math-ST">math.ST - 통계 이론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="math.PR" id="cat-math-PR"><label class="form-check-label small" for="cat-math-PR">math.PR - 확률론</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="q-bio.QM" id="cat-qbio-QM"><label class="form-check-label small" for="cat-qbio-QM">q-bio.QM - 정량적 생물학</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="q-bio.NC" id="cat-qbio-NC"><label class="form-check-label small" for="cat-qbio-NC">q-bio.NC - 뉴런 및 인지</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="q-fin.ST" id="cat-qfin-ST"><label class="form-check-label small" for="cat-qfin-ST">q-fin.ST - 통계 금융</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="q-fin.CP" id="cat-qfin-CP"><label class="form-check-label small" for="cat-qfin-CP">q-fin.CP - 전산 금융</label></div></div>
                                                <div class="col"><div class="form-check"><input class="form-check-input cat-check" type="checkbox" value="physics.data-an" id="cat-phys-da"><label class="form-check-label small" for="cat-phys-da">physics.data-an - 데이터 분석 (물리)</label></div></div>
                                            </div>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted">선택됨: </small><small id="selectedCatsDisplay" class="text-primary">없음</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">알림 설정</label>
                                        <div id="notifyChannels">
                                            <!-- Channels added dynamically -->
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addNotifyChannel()">
                                            + 알림 채널 추가
                                        </button>
                                        <small class="text-muted d-block mt-1">여러 채널에 알림을 보낼 수 있습니다. 초기 설정 탭에서 API 키를 먼저 설정하세요.</small>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn btn-primary" id="saveTopicBtn">저장</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Tab -->
            <div class="tab-pane fade" id="search" role="tabpanel">
                <p class="tab-subtitle">등록한 토픽을 기반으로 AI가 키워드를 생성하고, arXiv에서 논문을 수집합니다.</p>

                <!-- Step flow indicator removed -->

                <!-- Step 1: Keyword Generation -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#dryrunBody">
                        <h5 class="mb-0">Step 1: 키워드 생성</h5>
                        <span class="dryrun-toggle-icon" style="transition: transform 0.2s; font-size: 1.2rem; color: #6c757d;">&#9660;</span>
                    </div>
                    <div class="collapse show" id="dryrunBody">
                    <div class="card-body">
                        <p class="text-muted">AI가 토픽에 맞는 검색 키워드와 arXiv 쿼리를 생성합니다. 논문 검색 전에 먼저 실행하세요.</p>

                        <div class="mb-3">
                            <label class="form-label">토픽</label>
                            <select class="form-select" id="dryrunTopicSelect">
                                <option value="">전체 토픽</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-primary" id="runDryRunBtn">키워드 생성</button>
                            <button class="btn btn-sm btn-outline-secondary" id="cancelDryRunBtn" style="display: none;">취소</button>
                            <button class="btn btn-sm btn-outline-primary" id="rerunDryRunBtn" style="display: none;">다시 생성 (캐시 무시)</button>
                        </div>

                        <!-- Progress bar -->
                        <div id="dryrunProgress" style="display: none;">
                            <div id="dryrunProgressContainer" class="position-relative mb-3" style="background: #1e1e2e; border-radius: 8px; padding: 12px 16px; min-height: 56px;">
                                <div id="dryrunProgressBar" class="progress-bar-fill" style="position: absolute; top: 0; left: 0; height: 100%; background: rgba(99, 102, 241, 0.2); border-radius: 8px; transition: width 0.3s ease; width: 0%;"></div>
                                <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 1;">
                                    <div>
                                        <span id="dryrunProgressMsg" class="progress-msg-text" style="color: #a5b4fc; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.875rem;">초기화 중...</span>
                                        <span id="dryrunElapsed" class="progress-elapsed"></span>
                                    </div>
                                    <span id="dryrunProgressPct" style="color: #818cf8; font-family: 'SF Mono', monospace; font-size: 0.875rem; font-weight: 600;">0%</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button id="toggleDryRunLogBtn" class="btn btn-sm" onclick="toggleDryRunLog()"
                                        style="background: transparent; color: #9ca3af; border: 1px solid #374151; font-size: 0.75rem; padding: 2px 8px;">
                                    &#9660; 상세 로그 접기
                                </button>
                                <div id="dryrunLog" style="display: block; margin-top: 8px; max-height: 300px; overflow-y: auto; background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 8px 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.75rem; line-height: 1.6; color: #c9d1d9;">
                                </div>
                            </div>
                        </div>

                        <div id="dryrunResults" class="mt-3" style="display: none;">
                            <h6>생성된 키워드 및 쿼리:</h6>
                            <div id="dryrunResultsContent"></div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Step 2: Paper Search -->
                <div class="card mb-3" id="step2Card">
                    <div class="card-header">
                        <h5 class="mb-0">Step 2: 논문 검색</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">생성된 키워드를 사용하여 논문을 수집하고 평가합니다: 논문 수집 → 평가 → 요약 → 리포트 생성</p>

                        <!-- Keyword status notice -->
                        <div id="keywordStatusNotice" class="alert alert-info d-flex align-items-center mb-3" style="font-size: 0.9rem;">
                            <span style="font-size: 1.2rem; margin-right: 8px;">&#9432;</span>
                            <span>먼저 <strong>Step 1</strong>에서 키워드를 생성해주세요. 키워드가 없으면 논문 검색 시 자동으로 생성됩니다.</span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">토픽</label>
                            <select class="form-select" id="searchTopicSelect">
                                <option value="">전체 토픽</option>
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">시작일</label>
                                <input type="date" class="form-control" id="dateFrom">
                                <small class="text-muted">비워두면 이전 실행 이후만 수집합니다 (첫 실행은 최근 72시간).</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">종료일</label>
                                <input type="date" class="form-control" id="dateTo">
                                <small class="text-muted">비워두면 오늘 UTC 00:00 기준으로 처리됩니다.</small>
                            </div>
                        </div>
                        <div class="mb-3"></div>

                        <div class="mb-3">
                            <label class="form-label">중복 제거</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dedupMode" id="dedupSkip" value="skip_recent" checked>
                                    <label class="form-check-label" for="dedupSkip">최근 논문 건너뛰기</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dedupMode" id="dedupNone" value="none">
                                    <label class="form-check-label" for="dedupNone">중복 허용</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-success" id="startSearchBtn">논문 검색 시작</button>
                            <button class="btn btn-sm btn-outline-secondary" id="cancelSearchBtn" style="display: none;">취소</button>
                            <button class="btn btn-sm btn-outline-success" id="rerunSearchBtn" style="display: none;">다시 실행</button>
                            <button class="btn btn-sm btn-outline-warning" id="resetPipelineBtn" title="파이프라인 상태를 강제 초기화합니다">상태 초기화</button>
                            <button class="btn btn-sm btn-outline-info" id="weeklyRunBtn" title="위클리 리포트를 수동으로 생성합니다">위클리 실행</button>
                        </div>

                        <!-- Weekly run status -->
                        <div id="weeklyProgress" class="mt-2" style="display: none;">
                            <div class="position-relative mb-2" style="background: #1e1e2e; border-radius: 8px; padding: 10px 14px;">
                                <span id="weeklyProgressMsg" style="color: #93c5fd; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.85rem;">위클리 실행 중...</span>
                            </div>
                        </div>

                        <!-- Progress bar -->
                        <div id="searchProgress" class="mt-3" style="display: none;">
                            <div class="position-relative mb-3" style="background: #1e1e2e; border-radius: 8px; padding: 12px 16px; min-height: 56px;">
                                <div id="searchProgressBar" style="position: absolute; top: 0; left: 0; height: 100%; background: rgba(34, 197, 94, 0.2); border-radius: 8px; transition: width 0.3s ease; width: 0%;"></div>
                                <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 1;">
                                    <span id="searchProgressMsg" style="color: #86efac; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.875rem;">시작 중...</span>
                                    <span id="searchProgressPct" style="color: #4ade80; font-family: 'SF Mono', monospace; font-size: 0.875rem; font-weight: 600;">0%</span>
                                </div>
                            </div>
                            <!-- Log toggle + display -->
                            <div class="mt-2">
                                <button id="toggleLogBtn" class="btn btn-sm" onclick="toggleLog()"
                                        style="background: transparent; color: #9ca3af; border: 1px solid #374151; font-size: 0.75rem; padding: 2px 8px;">
                                    &#9654; 상세 로그 보기
                                </button>
                                <div id="logContainer" style="display: none; margin-top: 8px; max-height: 300px; overflow-y: auto; background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 8px 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.75rem; line-height: 1.6; color: #c9d1d9;">
                                </div>
                            </div>
                        </div>

                        <div id="searchResults" class="mt-3" style="display: none;">
                            <h6>결과:</h6>
                            <div id="searchResultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <p class="tab-subtitle">파이프라인 세부 동작을 조정합니다. 기본값으로도 잘 작동하니 필요한 것만 변경하세요.</p>

                <!-- Configuration Editor -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">설정 편집기</h5>
                    </div>
                    <div class="card-body" id="configEditor">
                        <div class="text-center text-muted">로딩 중...</div>
                    </div>
                </div>

                <!-- Database Status -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">데이터 관리</h5>
                        <button class="btn btn-sm btn-secondary" id="refreshDbBtn">새로고침</button>
                    </div>
                    <div class="card-body" id="dbStatus">
                        <div class="text-center text-muted">로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dry-run collapse toggle icon rotation
        const dryrunCollapse = document.getElementById('dryrunBody');
        const dryrunToggleIcon = document.querySelector('.dryrun-toggle-icon');
        dryrunCollapse.addEventListener('hide.bs.collapse', () => {
            dryrunToggleIcon.style.transform = 'rotate(-90deg)';
        });
        dryrunCollapse.addEventListener('show.bs.collapse', () => {
            dryrunToggleIcon.style.transform = 'rotate(0deg)';
        });

        // Global variables for polling
        let pollInterval = null;
        let lastLogOffset = 0;
        let logVisible = false;
        let logAutoScroll = true;

        function toggleLog() {
            const container = document.getElementById('logContainer');
            const btn = document.getElementById('toggleLogBtn');
            logVisible = !logVisible;
            container.style.display = logVisible ? 'block' : 'none';
            btn.innerHTML = logVisible ? '&#9660; 로그 접기' : '&#9654; 상세 로그 보기';
        }

        function getLogLineColor(msg, step) {
            const lower = (msg || '').toLowerCase() + ' ' + (step || '').toLowerCase();
            if (lower.includes('error') || lower.includes('fail')) return '#f87171';
            if (lower.includes('complete') || lower.includes('done') || lower.includes('passed')) return '#86efac';
            if (lower.includes('starting') || lower.includes('중') || step === 'collect_query') return '#fbbf24';
            return '#c9d1d9';
        }

        function formatLogTime(ts) {
            if (!ts) return '';
            try {
                const d = new Date(ts);
                return d.toTimeString().slice(0, 8);
            } catch { return ''; }
        }

        async function fetchLogs() {
            try {
                const resp = await fetch('/api/pipeline/logs?offset=' + lastLogOffset);
                if (!resp.ok) return;
                const data = await resp.json();
                if (!data.lines || data.lines.length === 0) return;

                const container = document.getElementById('logContainer');
                const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 30;

                for (const line of data.lines) {
                    const div = document.createElement('div');
                    const color = getLogLineColor(line.msg, line.step);
                    const timeStr = formatLogTime(line.ts);
                    div.style.color = color;
                    div.textContent = (timeStr ? '[' + timeStr + '] ' : '') + (line.msg || '');
                    container.appendChild(div);
                }

                lastLogOffset = data.total;

                if (logAutoScroll && wasAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch { /* ignore */ }
        }

        // Load all data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTopics();
            loadSettings();
            loadDbStatus();
            loadSearchTopics();
            loadSetupStatus();

            // Scroll to top on tab switch to prevent position drift
            document.getElementById('mainTabs').addEventListener('shown.bs.tab', () => {
                window.scrollTo(0, 0);
            });
        });

        // Toggle password visibility
        function togglePassword(btn) {
            const input = btn.parentElement.querySelector('input');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '숨기기';
            } else {
                input.type = 'password';
                btn.textContent = '보기';
            }
        }

        // Real-time input validation for setup fields
        const SETUP_VALIDATORS = {
            openrouter: v => v.startsWith('sk-or-'),
            telegram_token: v => v.includes(':'),
            telegram_chat: v => v.trim().length > 0,
            discord: v => v.startsWith('https://discord.com/api/webhooks/'),
            github: v => v.startsWith('ghp_') || v.startsWith('github_pat_'),
            supabase_db: v => v.startsWith('postgresql://'),
            supabase_url: v => v.startsWith('https://') && v.includes('supabase'),
            supabase_anon: v => v.startsWith('eyJ'),
        };

        document.querySelectorAll('[data-validate]').forEach(input => {
            input.addEventListener('input', () => {
                const val = input.value.trim();
                const validatorKey = input.dataset.validate;
                const validator = SETUP_VALIDATORS[validatorKey];
                // Find the parent setup-field and look for existing badge or create one
                const field = input.closest('.setup-field');
                if (!field) return;
                let badge = field.querySelector('.validation-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'validation-badge';
                    const label = field.querySelector('label');
                    if (label) label.appendChild(badge);
                }
                if (!val) {
                    badge.textContent = '';
                } else if (validator && validator(val)) {
                    badge.textContent = ' \u2705';
                    badge.style.color = 'var(--ps-success)';
                } else {
                    badge.textContent = ' \u274C';
                    badge.style.color = 'var(--ps-danger)';
                }
            });
        });

        // Load setup status and auto-activate tab if needed
        async function loadSetupStatus() {
            try {
                const response = await fetch('/api/setup/status');
                const status = await response.json();

                // Define groups for progress calculation
                const groups = [
                    { name: 'AI 모델 API', keys: ['OPENROUTER_API_KEY'], required: true },
                    { name: '알림', keys: ['TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID'], required: false },
                    { name: 'GitHub', keys: ['GITHUB_TOKEN'], required: false },
                    { name: 'Supabase', keys: ['SUPABASE_DB_URL'], required: false },
                ];

                let completedGroups = 0;
                const totalGroups = groups.length;

                // Update individual key badges
                const envKeys = ['OPENROUTER_API_KEY', 'GITHUB_TOKEN', 'TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID', 'DISCORD_WEBHOOK_URL', 'SUPABASE_DB_URL'];
                for (const key of envKeys) {
                    const badge = document.getElementById(`setupBadge_${key}`);
                    const input = document.getElementById(`setupKey_${key}`);
                    const info = status.env[key];
                    if (!badge) continue;
                    if (info && info.exists) {
                        badge.className = info.valid ? 'badge bg-success' : 'badge bg-warning';
                        badge.textContent = info.valid ? '유효' : '형식 오류';
                        if (input) input.placeholder = info.masked_value || '(등록됨)';
                    } else {
                        badge.className = 'badge bg-secondary';
                        badge.textContent = key === 'OPENROUTER_API_KEY' ? '필수' : '미입력';
                    }
                }

                // Notification group badge
                const notifBadge = document.getElementById('setupBadge_notifications');
                if (notifBadge) {
                    const tgOk = status.env.TELEGRAM_BOT_TOKEN?.exists && status.env.TELEGRAM_CHAT_ID?.exists;
                    const dcOk = status.env.DISCORD_WEBHOOK_URL?.exists;
                    if (tgOk || dcOk) {
                        notifBadge.className = 'badge bg-success';
                        notifBadge.textContent = '설정됨';
                    } else {
                        notifBadge.className = 'badge bg-secondary';
                        notifBadge.textContent = '미입력';
                    }
                }

                // Calculate progress
                for (const group of groups) {
                    const allOk = group.keys.every(k => status.env[k]?.exists && status.env[k]?.valid);
                    if (allOk) completedGroups++;
                }

                // Update progress bar
                const pct = Math.round((completedGroups / totalGroups) * 100);
                const fillEl = document.getElementById('setupProgressFill');
                const textEl = document.getElementById('setupProgressText');
                if (fillEl) fillEl.style.width = pct + '%';
                if (textEl) textEl.textContent = `설정 완료: ${completedGroups}/${totalGroups} (${pct}%)`;

                // Update repo info
                const repoDiv = document.getElementById('setupRepoInfo');
                if (status.repo && !status.repo.error) {
                    repoDiv.innerHTML = `<span style="font-size: 0.85rem;">저장소 감지됨: <a href="${status.repo.url}" target="_blank">${status.repo.full_name}</a></span>`;
                } else {
                    repoDiv.innerHTML = `<span class="text-warning" style="font-size: 0.85rem;">Git 레포 미감지</span>`;
                }

                // Also load Supabase config fields from settings
                try {
                    const settingsResp = await fetch('/api/settings');
                    const settings = await settingsResp.json();
                    if (settings.read_sync) {
                        const urlInput = document.getElementById('setupSupabaseUrl');
                        const keyInput = document.getElementById('setupSupabaseAnonKey');
                        if (urlInput && settings.read_sync.supabase_url) {
                            urlInput.placeholder = settings.read_sync.supabase_url ? '(등록됨) ' + settings.read_sync.supabase_url.substring(0, 30) + '...' : 'https://xxx.supabase.co';
                        }
                        if (keyInput && settings.read_sync.supabase_anon_key) {
                            keyInput.placeholder = '(등록됨) eyJ...';
                        }
                    }
                } catch (e) { /* ignore */ }

                // Auto-activate Setup tab if setup is needed
                if (status.needs_setup) {
                    const setupTab = document.getElementById('setup-tab');
                    const topicsTab = document.getElementById('topics-tab');
                    const setupPane = document.getElementById('setup');
                    const topicsPane = document.getElementById('topics');

                    topicsTab.classList.remove('active');
                    topicsPane.classList.remove('show', 'active');
                    setupTab.classList.add('active');
                    setupPane.classList.add('show', 'active');
                }
            } catch (error) {
                console.error('Error loading setup status:', error);
            }
        }

        // Global Save — routes to active tab's save logic
        async function globalSave() {
            const activeTab = document.querySelector('#mainTabs .nav-link.active');
            const tabId = activeTab ? activeTab.getAttribute('data-bs-target') : '';
            const btn = document.getElementById('globalSaveBtn');
            const origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '저장 중...';

            try {
                if (tabId === '#setup') {
                    await saveAndDeploy();
                } else if (tabId === '#settings') {
                    await saveSettings();
                } else {
                    // Topics and search tabs don't have saveable forms
                    alert('등록 또는 설정 탭에서 변경한 내용이 있을 때 저장해주세요.');
                    return;
                }
                // Brief success feedback
                btn.textContent = '저장 완료';
                btn.classList.replace('btn-primary', 'btn-success');
                setTimeout(() => { btn.textContent = origText; btn.classList.replace('btn-success', 'btn-primary'); }, 1500);
            } catch (e) {
                alert(`저장 오류: ${e.message}`);
                btn.textContent = origText;
            } finally {
                btn.disabled = false;
            }
        }

        // Save & Deploy (setup tab)
        async function saveAndDeploy() {
            const resultsDiv = document.getElementById('deployResults');

            // Collect env values (only non-empty)
            const envData = {};
            const envKeys = ['OPENROUTER_API_KEY', 'GITHUB_TOKEN', 'DISCORD_WEBHOOK_URL', 'TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID', 'SUPABASE_DB_URL'];
            for (const key of envKeys) {
                const input = document.getElementById(`setupKey_${key}`);
                if (input) {
                    const val = input.value.trim();
                    if (val) envData[key] = val;
                }
            }

            // Collect Supabase config fields
            const supabaseUrl = (document.getElementById('setupSupabaseUrl')?.value || '').trim();
            const supabaseAnonKey = (document.getElementById('setupSupabaseAnonKey')?.value || '').trim();

            // Dependency warnings
            const warnings = [];

            // Telegram: Bot Token without Chat ID
            const hasTgToken = envData.TELEGRAM_BOT_TOKEN || document.getElementById('setupKey_TELEGRAM_BOT_TOKEN')?.placeholder?.includes('***');
            const hasTgChat = envData.TELEGRAM_CHAT_ID || document.getElementById('setupKey_TELEGRAM_CHAT_ID')?.placeholder?.includes('***');
            if ((envData.TELEGRAM_BOT_TOKEN && !hasTgChat) || (envData.TELEGRAM_CHAT_ID && !hasTgToken)) {
                warnings.push('Bot Token과 Chat ID를 둘 다 입력해야 알림이 작동합니다.');
            }

            // GitHub Token without Actions checkbox
            const hasGhToken = envData.GITHUB_TOKEN || document.getElementById('setupKey_GITHUB_TOKEN')?.placeholder?.includes('***');
            const pushSecrets = document.getElementById('pushSecretsCheck').checked;
            if (envData.GITHUB_TOKEN && !pushSecrets) {
                warnings.push('GitHub Token을 등록했지만 Actions 반영이 꺼져 있습니다. 자동 실행을 원하면 체크하세요.');
            }

            // Supabase: DB URL without URL/Key
            const hasDbUrl = envData.SUPABASE_DB_URL || document.getElementById('setupKey_SUPABASE_DB_URL')?.placeholder?.includes('***');
            if (hasDbUrl && !supabaseUrl && !supabaseAnonKey) {
                const existingUrl = document.getElementById('setupSupabaseUrl')?.placeholder?.includes('등록됨');
                if (!existingUrl) {
                    warnings.push('DB 연결은 되지만 읽음 동기화가 작동하지 않습니다. 3개 모두 입력하면 완전히 연동됩니다.');
                }
            }

            // No OpenRouter key at all
            const hasOpenRouter = envData.OPENROUTER_API_KEY || document.getElementById('setupKey_OPENROUTER_API_KEY')?.placeholder?.includes('***');
            if (!hasOpenRouter) {
                warnings.push('AI 모델 API 키가 없으면 논문 수집이 불가능합니다.');
            }

            // Show warnings
            if (warnings.length > 0) {
                const warningMsg = warnings.join('\n\n') + '\n\n그래도 저장하시겠습니까?';
                if (!confirm(warningMsg)) return;
            }

            if (resultsDiv) resultsDiv.style.display = 'none';

            // Build config updates for Supabase fields
            let configUpdates = null;
            if (supabaseUrl || supabaseAnonKey) {
                configUpdates = { read_sync: {} };
                if (supabaseUrl) configUpdates.read_sync.supabase_url = supabaseUrl;
                if (supabaseAnonKey) configUpdates.read_sync.supabase_anon_key = supabaseAnonKey;
            }

            try {
                const response = await fetch('/api/setup/save-and-deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        env: Object.keys(envData).length > 0 ? envData : null,
                        config: configUpdates,
                        push_secrets: pushSecrets,
                    })
                });

                const result = await response.json();

                const stepLabels = {
                    'config': '설정 파일',
                    'env': '환경 변수',
                    'github_secrets': 'GitHub Actions',
                };

                let html = '';
                for (const step of result.steps) {
                    let icon, cls;
                    if (step.status === 'ok') { icon = '&#10004;'; cls = 'text-success'; }
                    else if (step.status === 'skipped') { icon = '&#8212;'; cls = 'text-muted'; }
                    else if (step.status === 'partial') { icon = '&#9888;'; cls = 'text-warning'; }
                    else { icon = '&#10008;'; cls = 'text-danger'; }

                    const stepName = stepLabels[step.step] || step.step;
                    html += `<div class="step-result">
                        <span class="${cls}"><strong>${icon} ${stepName}</strong></span>
                        <span class="ms-2">${step.status === 'ok' ? '완료' : step.status === 'skipped' ? '건너뜀' : step.status}</span>`;

                    if (step.error) html += `<br><small class="text-danger">${step.error}</small>`;
                    if (step.manual_url) html += `<br><small><a href="${step.manual_url}" target="_blank">수동으로 시크릿 설정</a></small>`;
                    if (step.results) {
                        const details = Object.entries(step.results).map(([k, v]) => `${k}: ${v}`).join(', ');
                        html += `<br><small class="text-muted">${details}</small>`;
                    }
                    html += '</div>';
                }

                if (result.success) {
                    html = `<div class="alert alert-success">${html}</div>`;
                } else {
                    html = `<div class="alert alert-warning">${html}</div>`;
                }

                if (resultsDiv) { resultsDiv.innerHTML = html; resultsDiv.style.display = 'block'; }

                // Refresh status
                loadSetupStatus();

                // Clear inputs
                for (const key of envKeys) {
                    const input = document.getElementById(`setupKey_${key}`);
                    if (input) input.value = '';
                }
                const sUrlInput = document.getElementById('setupSupabaseUrl');
                const sKeyInput = document.getElementById('setupSupabaseAnonKey');
                if (sUrlInput) sUrlInput.value = '';
                if (sKeyInput) sKeyInput.value = '';
            } catch (error) {
                if (resultsDiv) { resultsDiv.innerHTML = `<div class="alert alert-danger">오류: ${error.message}</div>`; resultsDiv.style.display = 'block'; }
                throw error;
            }
        }

        // Sync data files to GitHub Actions
        // syncActions() removed — handled by Settings tab "GitHub 배포" button

        // Add topic button
        document.getElementById('addTopicBtn').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('addTopicModal'));
            modal.show();
        });

        // Save topic (create or edit)
        document.getElementById('saveTopicBtn').addEventListener('click', async () => {
            const form = document.getElementById('addTopicForm');
            const formData = new FormData(form);
            const modalEl = document.getElementById('addTopicModal');
            const editSlug = modalEl.dataset.editSlug;

            const selectedCats = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value);
            if (selectedCats.length === 0) {
                alert('arXiv 카테고리를 1개 이상 선택해 주세요.');
                return;
            }

            const notifyList = collectNotifyChannels();

            if (editSlug) {
                // Edit mode: PUT request
                const updates = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    arxiv_categories: selectedCats,
                    notify: notifyList
                };

                try {
                    const putResponse = await fetch(`/api/topics/${editSlug}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });
                    if (putResponse.ok) {
                        const result = await putResponse.json();
                        if (result.cache_invalidated) {
                            alert('토픽이 수정되었습니다. 설명이 변경되어 키워드 캐시를 새로고침해야 할 수 있습니다.');
                        } else {
                            alert('토픽이 수정되었습니다.');
                        }
                        bootstrap.Modal.getInstance(modalEl).hide();
                        loadTopics();
                        loadSearchTopics();
                    } else {
                        const error = await putResponse.json();
                        alert(`Error: ${error.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            } else {
                // Create mode: POST request
                const data = {
                    slug: formData.get('slug'),
                    name: formData.get('name'),
                    description: formData.get('description'),
                    arxiv_categories: selectedCats,
                    notify: notifyList
                };

                try {
                    const response = await fetch('/api/topics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('토픽이 생성되었습니다.');
                        bootstrap.Modal.getInstance(modalEl).hide();
                        form.reset();
                        loadTopics();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
        });

        // Refresh topics
        document.getElementById('refreshTopicsBtn').addEventListener('click', loadTopics);

        // Load topics function
        async function loadTopics() {
            const container = document.getElementById('topicsList');
            container.innerHTML = '<div class="text-center text-muted">토픽 로딩 중...</div>';

            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();

                if (topics.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">등록된 토픽이 없습니다.</div>';
                    return;
                }

                let html = '<div class="list-group">';
                for (const topic of topics) {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${topic.name}</h5>
                                <small class="text-muted">${topic.slug}</small>
                            </div>
                            <p class="mb-1">${topic.description}</p>
                            <small>카테고리: ${topic.arxiv_categories.join(', ')}</small>
                            <br>
                            <small>최근 실행: ${topic.last_run_date || '없음'} | 수집: ${topic.total_collected || 0} | 출력: ${topic.total_output || 0}</small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="editTopic('${topic.slug}')">수정</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTopic('${topic.slug}', '${topic.name}')">삭제</button>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">토픽 로딩 오류: ${error.message}</div>`;
            }
        }

        // Notify channel management
        function addNotifyChannel(provider, secretKey, events, sendModes) {
            const container = document.getElementById('notifyChannels');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'notify-channel-row border rounded p-2 mb-2';
            const providerVal = provider || 'telegram';
            const secretKeyVal = secretKey || '';
            const sendArr = Array.isArray(sendModes) ? sendModes : ['link'];
            const startChecked = (events && events.includes('start')) ? 'checked' : '';
            const completeChecked = (events && events.includes('complete')) ? 'checked' : (!events ? 'checked' : (events.includes('complete') ? 'checked' : ''));
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>채널 ${count}</strong>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeNotifyChannel(this)">삭제</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <select class="form-select form-select-sm notify-provider">
                            <option value="telegram" ${providerVal === 'telegram' ? 'selected' : ''}>Telegram</option>
                            <option value="discord" ${providerVal === 'discord' ? 'selected' : ''}>Discord</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm notify-secret-key" placeholder="Secret Key" value="${secretKeyVal}">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input notify-event-start" type="checkbox" value="start" ${startChecked}>
                            <label class="form-check-label">시작</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input notify-event-complete" type="checkbox" value="complete" ${completeChecked}>
                            <label class="form-check-label">완료</label>
                        </div>
                    </div>
                </div>
                <table class="table table-borderless table-sm mb-0 mt-1"><tbody>
                <tr>
                    <td colspan="3">
                        <label class="form-label mb-1" style="font-size:0.85em; color: var(--bs-secondary)">전송 항목</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input send-mode" type="checkbox" value="link" ${sendArr.includes('link') ? 'checked' : ''}>
                                <label class="form-check-label" style="font-size:0.85em">GitHub Pages 링크 (읽음 추적)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input send-mode" type="checkbox" value="readonly_link" ${sendArr.includes('readonly_link') ? 'checked' : ''}>
                                <label class="form-check-label" style="font-size:0.85em">읽기전용 GitHub Pages 링크</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input send-mode" type="checkbox" value="md" ${sendArr.includes('md') ? 'checked' : ''}>
                                <label class="form-check-label" style="font-size:0.85em">Markdown 파일 첨부</label>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody></table>
            `;
            container.appendChild(div);
        }

        function removeNotifyChannel(btn) {
            btn.closest('.notify-channel-row').remove();
            document.querySelectorAll('.notify-channel-row strong').forEach((el, i) => {
                el.textContent = `채널 ${i + 1}`;
            });
        }

        function collectNotifyChannels() {
            const rows = document.querySelectorAll('.notify-channel-row');
            if (rows.length === 0) return null;
            const channels = [];
            for (const row of rows) {
                const provider = row.querySelector('.notify-provider').value;
                const secretKey = row.querySelector('.notify-secret-key').value.trim();
                if (!secretKey) continue;
                const events = [];
                if (row.querySelector('.notify-event-start').checked) events.push('start');
                if (row.querySelector('.notify-event-complete').checked) events.push('complete');
                if (events.length === 0) events.push('complete');
                const sendCheckboxes = row.querySelectorAll('.send-mode:checked');
                const send = Array.from(sendCheckboxes).map(cb => cb.value);
                if (send.length === 0) send.push('link');
                channels.push({
                    provider: provider,
                    channel_id: '',
                    secret_key: secretKey,
                    events: events,
                    send: send
                });
            }
            return channels.length > 0 ? channels : null;
        }

        function updateCatDisplay() {
            const selected = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value);
            document.getElementById('selectedCatsDisplay').textContent = selected.length > 0 ? `${selected.join(', ')} (${selected.length}개)` : '없음';
            const warning = document.getElementById('catWarning');
            if (selected.length > 10) {
                warning.classList.remove('d-none');
            } else {
                warning.classList.add('d-none');
            }
        }

        async function aiRecommendCategories() {
            const desc = document.querySelector('#addTopicForm textarea[name="description"]').value.trim();
            if (!desc) {
                alert('설명을 먼저 입력해 주세요.');
                return;
            }

            const btn = document.getElementById('aiRecommendBtn');
            const spinner = document.getElementById('aiRecommendSpinner');
            btn.disabled = true;
            spinner.classList.remove('d-none');

            try {
                const response = await fetch('/api/recommend/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: desc })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || '추천 실패');
                }

                // Uncheck all first
                document.querySelectorAll('.cat-check').forEach(cb => cb.checked = false);

                // Check recommended categories
                let matched = 0;
                for (const cat of result.categories) {
                    const cb = document.querySelector(`.cat-check[value="${cat}"]`);
                    if (cb) {
                        cb.checked = true;
                        matched++;
                    }
                }

                updateCatDisplay();

                const methodLabel = result.method === 'llm' ? 'AI' : 'Rule-based';
                alert(`${methodLabel} 추천 완료: ${matched}개 카테고리 선택됨\n\n${result.reasoning || ''}`);
            } catch (error) {
                alert(`추천 실패: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('cat-check')) {
                updateCatDisplay();
            }
        });

        // Reset form when modal closes
        document.getElementById('addTopicModal').addEventListener('hidden.bs.modal', () => {
            document.querySelectorAll('.cat-check').forEach(cb => cb.checked = false);
            document.getElementById('selectedCatsDisplay').textContent = '없음';
            document.getElementById('notifyChannels').innerHTML = '';
            // Clear edit mode state
            const modalEl = document.getElementById('addTopicModal');
            delete modalEl.dataset.editSlug;
            document.getElementById('saveTopicBtn').textContent = '저장';
            const slugInput = document.querySelector('#addTopicForm [name="slug"]');
            if (slugInput) slugInput.readOnly = false;
        });

        // Edit topic - opens the add/edit modal pre-populated
        async function editTopic(slug) {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();
                const topic = topics.find(t => t.slug === slug);
                if (!topic) { alert('토픽을 찾을 수 없습니다.'); return; }

                // Populate form fields
                const form = document.getElementById('addTopicForm');
                form.querySelector('[name="slug"]').value = topic.slug;
                form.querySelector('[name="slug"]').readOnly = true;
                form.querySelector('[name="name"]').value = topic.name;
                form.querySelector('[name="description"]').value = topic.description;

                // Check matching categories
                document.querySelectorAll('.cat-check').forEach(cb => cb.checked = false);
                for (const cat of (topic.arxiv_categories || [])) {
                    const cb = document.querySelector(`.cat-check[value="${cat}"]`);
                    if (cb) cb.checked = true;
                }
                updateCatDisplay();

                // Populate notify channels
                document.getElementById('notifyChannels').innerHTML = '';
                const notifyList = Array.isArray(topic.notify) ? topic.notify : (topic.notify ? [topic.notify] : []);
                for (const nc of notifyList) {
                    addNotifyChannel(nc.provider, nc.secret_key, nc.events || ['complete'], nc.send || ['link']);
                }

                // Mark modal as edit mode
                const modal = document.getElementById('addTopicModal');
                modal.dataset.editSlug = slug;
                document.getElementById('saveTopicBtn').textContent = '수정';
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Delete topic
        async function deleteTopic(slug, name) {
            if (!confirm(`"${name}" 토픽을 삭제하시겠습니까?`)) return;
            try {
                const response = await fetch(`/api/topics/${slug}`, { method: 'DELETE' });
                if (response.ok) {
                    loadTopics();
                    loadSearchTopics();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Section display names and descriptions
        const SECTION_LABELS = {
            app: '일반',
            llm: 'AI 모델',
            agents: 'AI 세부 조정',
            sources: '논문 검색',
            filter: '검색 결과 제한',
            embedding: '유사도 분석',
            scoring: '논문 선별 기준',
            remind: '놓친 논문 재추천',
            clustering: '유사 논문 묶기',
            output: '리포트 배포',
            database: '저장소',
            weekly: '주간 리포트',
            local_ui: '로컬 UI',
            read_sync: '읽음 동기화'
        };

        const SECTION_DESCRIPTIONS = {
            app: '시간대와 리포트 보관 기간을 설정합니다.',
            llm: '어떤 AI를 쓸지 선택합니다. 무료 모델도 있고, 유료 모델은 더 정확합니다.',
            agents: '보통은 변경할 필요 없습니다.',
            sources: 'arXiv에서 논문을 가져오는 방식을 조정합니다.',
            filter: '한 번에 처리할 논문이 너무 많으면 여기서 제한합니다.',
            embedding: '논문 유사도 계산. sentence-transformers 미설치 시 자동으로 건너뜁니다.',
            scoring: '점수가 높을수록 관련성이 높은 논문만 남깁니다. 숫자를 올리면 엄격해집니다.',
            remind: '이전에 놓친 좋은 논문을 다시 알려줍니다.',
            clustering: '비슷한 논문끼리 묶어서 리포트를 깔끔하게 정리합니다.',
            output: 'GitHub Pages 웹 리포트, 파일 첨부, Issue 자동 생성을 설정합니다.',
            database: 'Supabase를 등록했으면 클라우드, 아니면 로컬 파일에 저장됩니다.',
            weekly: '매주 자동으로 트렌드 키워드와 하이라이트 논문을 정리합니다.',
            local_ui: '로컬 UI 서버 주소와 포트 설정.',
            read_sync: '여러 기기에서 "읽음" 상태를 공유합니다. Supabase 등록이 필요합니다.'
        };

        // Nested group labels and hints (for sub-sections inside accordion sections)
        const NESTED_LABELS = {
            // agents
            'agents.common': ['공통', '보통은 변경할 필요 없습니다'],
            'agents.keyword_expander': ['키워드 생성', '토픽 설명을 바탕으로 arXiv 검색어를 만드는 AI'],
            'agents.scorer': ['논문 평가', '수집된 논문이 내 연구와 얼마나 관련 있는지 점수 매기는 AI'],
            'agents.summarizer': ['논문 요약', '점수 높은 논문의 핵심을 정리하는 AI'],
            // llm
            'llm.retry': ['실패 시 재시도', 'AI 응답이 없을 때 몇 번 다시 시도할지'],
            'llm.timeout': ['응답 대기', 'AI 응답을 몇 초까지 기다릴지'],
            'llm.preflight': ['호출 제한', '비용 초과를 방지하기 위한 API 사용량 제한'],
            'llm.fallback_models': ['예비 모델', '선택한 모델이 안 되면 이 모델들을 순서대로 시도'],
            // scoring
            'scoring.bonus': ['가산점', '특정 조건을 만족하면 추가 점수 부여'],
            'scoring.weights': ['점수 비중', '최종 점수를 계산할 때 각 항목의 중요도'],
            'scoring.weights.embedding_off': ['유사도 분석 안 할 때', '유사도 분석 없이 점수를 매기는 경우'],
            'scoring.weights.embedding_on': ['유사도 분석 할 때', '유사도 분석을 포함해서 점수를 매기는 경우'],
            'scoring.thresholds': ['선별 기준', '몇 점 이상인 논문만 남길지'],
            // database
            'database.retention': ['자동 정리', '오래된 데이터를 며칠 후 자동 삭제할지 설정'],
            'database.seen_items': ['중복 방지', '같은 논문이 두 번 수집되지 않도록 기록'],
            'database.persistence': ['내부 설정', '변경 불필요'],
            'database.release_backup': ['자동 백업', '매주 데이터를 자동으로 백업'],
            'database.usage': ['API 사용량', '얼마나 많이 AI를 호출했는지 기록'],
            'database.supabase': ['클라우드 연결', '등록 탭에서 Supabase를 등록하면 자동 설정됩니다'],
            // output
            'output.attachments': ['파일 첨부', '알림에 리포트 파일을 첨부할지'],
            'output.gh_pages': ['웹 리포트', 'GitHub Pages에 리포트를 자동 게시'],
            'output.github_issue': ['Issue 생성', '리포트를 GitHub Issue로 자동 등록'],
            // weekly
            'weekly.trend_summary': ['트렌드 요약', '이번 주 인기 키워드와 주요 논문 정리'],
            'weekly.update_scan': ['업데이트 감지', '이전에 수집한 논문의 새 버전이 나왔는지 확인'],
            'weekly.visualization': ['차트', '주간 트렌드를 그래프로 시각화'],
            // sources
            'sources.arxiv': ['arXiv', '논문을 가져오는 arXiv 사이트 연결 설정'],
        };

        const FIELD_HINTS = {
            // app
            'app.display_timezone': '리포트에 표시되는 시간대. 예: Asia/Seoul',
            'app.report_retention_days': '생성된 리포트 파일 보존 일수',
            'app.schedule_enabled': 'ON: 매일 자동 실행. OFF: 수동 실행만 가능',
            // llm
            'llm.provider': '변경 불필요',
            'llm.base_url': '변경 불필요',
            'llm.model': 'OpenRouter 모델 페이지에서 모델 ID를 복사해 붙여넣으세요',
            'llm.app_url': '변경 불필요',
            'llm.app_title': '변경 불필요',
            'llm.timeout.attempt_1': '첫 시도에서 AI 응답을 몇 초까지 기다릴지. 180 = 3분',
            'llm.timeout.attempt_2': '재시도할 때 몇 초까지 기다릴지',
            'llm.timeout.fallback': '예비 모델에서 몇 초까지 기다릴지',
            'llm.retry.max_retries': 'AI가 응답 안 하면 최대 몇 번 다시 시도할지',
            'llm.retry.backoff_base': '재시도 사이 대기 시간이 몇 배씩 늘어날지',
            'llm.retry.backoff_max': '재시도 대기 시간의 최대값 (초)',
            'llm.retry.jitter': 'ON: 재시도 타이밍을 랜덤으로 분산. OFF: 고정 간격',
            'llm.preflight.conservative_rpm': '1분에 최대 몇 번까지 AI를 호출할지',
            'llm.preflight.conservative_daily': '하루에 최대 몇 번까지 AI를 호출할지',
            // agents - common
            'agents.common.ignore_reasoning': 'ON: AI 추론 과정 무시, 결과만 사용',
            'agents.common.strip_think_blocks': 'ON: AI 내부 추론 텍스트 자동 제거',
            'agents.common.debug_dir': '문제 발생 시 로그가 저장되는 위치',
            // agents - keyword_expander
            'agents.keyword_expander.model': '비워두면 위의 AI 모델을 그대로 사용',
            'agents.keyword_expander.effort': '낮음=빠르지만 대략적, 보통=균형, 높음=느리지만 정밀',
            'agents.keyword_expander.max_tokens': 'AI 응답 최대 길이. 보통 변경 불필요',
            'agents.keyword_expander.temperature': '0에 가까울수록 일관적, 1에 가까울수록 다양한 결과',
            'agents.keyword_expander.prompt_version': '변경 불필요',
            'agents.keyword_expander.cache_ttl_days': '한 번 생성한 키워드를 며칠간 재사용할지',
            'agents.keyword_expander.chunk_size': '한 번에 몇 개의 키워드를 처리할지',
            // agents - scorer
            'agents.scorer.effort': '낮음=빠르지만 대략적, 보통=균형, 높음=느리지만 정밀',
            'agents.scorer.max_tokens': 'AI 응답 최대 길이. 보통 변경 불필요',
            'agents.scorer.temperature': '0에 가까울수록 일관적, 1에 가까울수록 다양한 결과',
            'agents.scorer.batch_size': '한 번에 몇 개의 논문을 평가할지. 크면 빠르지만 부정확할 수 있음',
            'agents.scorer.batch_timeout_seconds': '논문 평가 한 묶음당 최대 대기 시간 (초)',
            'agents.scorer.prompt_version': '변경 불필요',
            // agents - summarizer
            'agents.summarizer.model': '비워두면 위의 AI 모델을 그대로 사용',
            'agents.summarizer.effort': '낮음=빠르지만 대략적, 보통=균형, 높음=느리지만 정밀',
            'agents.summarizer.max_tokens': 'AI 응답 최대 길이. 보통 변경 불필요',
            'agents.summarizer.temperature': '0에 가까울수록 일관적, 1에 가까울수록 다양한 결과',
            'agents.summarizer.tier1_batch_size': '상위 논문 요약 시 한 번에 처리할 논문 수',
            'agents.summarizer.tier2_batch_size': '나머지 논문 요약 시 한 번에 처리할 논문 수',
            'agents.summarizer.tier1_prompt_version': '변경 불필요',
            'agents.summarizer.tier2_prompt_version': '변경 불필요',
            'agents.summarizer.tier2_summarize': 'OFF: 비용 절감 (brief_reason 사용). ON: 모든 논문에 LLM 요약',
            // sources
            'sources.arxiv.num_retries': 'arXiv API 실패 시 재시도 횟수',
            'sources.arxiv.delay_seconds': 'arXiv API 호출 간격(초). 3 미만은 차단 위험',
            'sources.arxiv.max_results_per_query': '쿼리당 최대 논문 수. 너무 크면 속도 저하',
            'sources.arxiv.empty_page_retries': '빈 결과 페이지 재시도 횟수',
            'sources.arxiv.empty_page_backoff': '빈 결과 시 재시도 대기 시간 목록 (초)',
            'sources.arxiv.window_buffer_minutes': '검색 시간 윈도우 여유분(분)',
            // filter
            'filter.pre_embed_cap': '이 수를 초과하면 점수가 낮은 논문부터 제외합니다',
            // embedding
            'embedding.model': '임베딩 모델. sentence-transformers 패키지 필요',
            'embedding.device': '연산 장치. cpu 또는 cuda (GPU)',
            'embedding.optional': 'ON: 미설치/실패 시 건너뜀 (권장). OFF: 실패하면 전체 중단',
            'embedding.mode': '임베딩 모드. en_synthetic: 영문 합성 텍스트 사용',
            // scoring
            'scoring.thresholds.relaxation_steps': '기준 점수를 단계적으로 낮추는 값 목록. 논문이 부족할 때 적용',
            'scoring.thresholds.default': '논문 포함 기준 점수 (0~100). 50이면 상위 50%만',
            'scoring.thresholds.min_papers': '최소 포함 논문 수. 이 수 미만이면 기준 완화',
            'scoring.weights.embedding_off.llm': 'AI 평가 점수 비중 (0~1). 높을수록 AI 판단 의존',
            'scoring.weights.embedding_off.recency': '최신성 점수 비중. 높을수록 최신 논문 우선',
            'scoring.weights.embedding_on.llm': '(임베딩 포함) AI 평가 점수 비중',
            'scoring.weights.embedding_on.embed': '(임베딩 포함) 유사도 점수 비중',
            'scoring.weights.embedding_on.recency': '(임베딩 포함) 최신성 점수 비중',
            'scoring.bonus.has_code': '코드 포함 논문 보너스 점수',
            'scoring.bonus.is_edge': '최신 연구 트렌드 논문 보너스 점수',
            'scoring.bonus.is_realtime': '실시간 관련 논문 보너스 점수',
            'scoring.discard_cutoff': '이 점수 미만 완전 제외. 0이면 모두 포함',
            'scoring.max_output': '최대 출력 논문 수. 9999이면 사실상 무제한',
            'scoring.tier1_count': 'Tier 1 (상세 요약 대상) 논문 수',
            // remind
            'remind.enabled': 'ON: 이전에 놓친 논문을 다시 추천. OFF: 새 논문만 표시',
            'remind.min_score': '재추천 대상 최소 점수. 80이면 상위 20%만',
            'remind.max_expose_count': '같은 논문 최대 재추천 횟수',
            // clustering
            'clustering.enabled': 'ON: 비슷한 논문끼리 묶어서 표시. OFF: 개별 나열',
            'clustering.similarity_threshold': '그룹핑 유사도 기준 (0~1). 0.85면 매우 유사한 것만',
            // output
            'output.gh_pages.enabled': 'ON: 리포트를 웹 페이지로 자동 게시',
            'output.gh_pages.base_url': 'GitHub Pages URL. 예: https://user.github.io/repo',
            'output.gh_pages.keep_files': 'ON: 이전 리포트 유지. OFF: 새 리포트만 표시',
            'output.gh_pages.retention_days': 'Pages에 올린 리포트 보존 일수',
            'output.github_issue.enabled': 'ON: 리포트를 GitHub Issue로 자동 생성',
            'output.github_issue.body_max_chars': 'Issue 본문 최대 글자수',
            'output.github_issue.labels': 'Issue에 자동으로 붙는 라벨 목록',
            'output.attachments.enabled': 'ON: 알림에 리포트 파일 첨부',
            // notifications
            'notifications.on_zero_results': 'ON: 수집 결과 없을 때 알림. OFF: 조용히 넘어감',
            'notifications.on_error': 'ON: 오류 발생 시 알림. OFF: 오류 무시',
            // database
            'database.provider': 'Supabase 등록 시 supabase, 미등록 시 sqlite (이 컴퓨터에 저장)',
            'database.path': 'Supabase 미사용 시 이 파일에 저장됩니다',
            'database.vacuum_after_purge': 'ON: 삭제 후 디스크 공간 정리. OFF: 그냥 삭제만',
            'database.papers_ttl_days': '논문을 며칠간 보관할지. 0이면 계속 보관',
            'database.retention.evaluations_days': '평가 결과를 며칠간 보관할지. 0이면 계속 보관',
            'database.retention.query_stats_days': '검색 기록을 며칠간 보관할지. 0이면 계속 보관',
            'database.retention.runs_days': '실행 기록을 며칠간 보관할지. 0이면 계속 보관',
            'database.seen_items.path': '이미 본 논문 기록 파일 위치',
            'database.seen_items.rolling_days': '며칠간 중복 체크할지',
            'database.usage.dir': 'API 사용량 기록 저장 위치',
            'database.usage.rolling_days': '사용량 기록을 며칠간 보관할지',
            'database.persistence.cache_key_prefix': '변경 불필요',
            'database.persistence.embed_cache_key_prefix': '변경 불필요',
            'database.release_backup.enabled': 'ON: 매주 자동 백업. OFF: 백업 안 함',
            'database.release_backup.keep_weeks': '백업을 몇 주간 보관할지',
            'database.release_backup.name_template': '백업 파일 이름 형식',
            'database.supabase.connection_string_env': '변경 불필요 (등록 탭에서 자동 설정됨)',
            // weekly
            'weekly.trend_summary.enabled': 'ON: 매주 트렌드 키워드와 하이라이트 정리',
            'weekly.trend_summary.top_keywords': '주간 트렌드에 표시할 키워드 수',
            'weekly.trend_summary.top_papers': '주간 하이라이트 논문 수',
            'weekly.update_scan.enabled': 'ON: 이전 논문의 새 버전 자동 감지',
            'weekly.update_scan.updated_within_days': '최근 며칠 이내 업데이트된 논문 검색',
            'weekly.update_scan.published_min_days': '최소 게시 경과 일수 (너무 최신은 제외)',
            'weekly.update_scan.published_max_days': '최대 게시 경과 일수 (너무 오래된 건 제외)',
            'weekly.visualization.enabled': 'ON: 주간 트렌드를 차트로 시각화',
            // local_ui
            'local_ui.host': '서버 바인딩 주소. 127.0.0.1은 로컬만 접근 가능',
            'local_ui.port': '로컬 UI 서버 포트 번호',
            'local_ui.open_browser': 'ON: 서버 시작 시 브라우저 자동 열기',
            // read_sync
            'read_sync.enabled': 'ON: 여러 기기에서 읽음 상태 공유 (Supabase 필요)',
            'read_sync.provider': '동기화 제공자. 현재 supabase만 지원',
        };

        // Korean labels for individual field names
        const FIELD_LABELS = {
            // app
            'display_timezone': '표시 시간대', 'report_retention_days': '리포트 보존 일수', 'schedule_enabled': '자동 실행',
            // llm
            'provider': '제공자', 'base_url': 'API URL', 'model': '모델', 'app_url': '프로젝트 URL', 'app_title': '프로젝트 이름', 'fallback_models': '대체 모델 목록',
            'attempt_1': '1차 시도', 'attempt_2': '2차 시도', 'fallback': '대체 모델',
            'max_retries': '최대 재시도', 'backoff_base': '간격 배수', 'backoff_max': '최대 간격', 'jitter': '랜덤 지연',
            'conservative_rpm': '분당 제한', 'conservative_daily': '일일 제한',
            // agents
            'ignore_reasoning': '추론 무시', 'strip_think_blocks': 'Think 태그 제거', 'debug_dir': '디버그 경로',
            'effort': '추론 강도', 'max_tokens': '최대 토큰', 'temperature': '창의성',
            'prompt_version': '프롬프트 버전', 'cache_ttl_days': '캐시 유효기간', 'chunk_size': '묶음 크기',
            'batch_size': '배치 크기', 'batch_timeout_seconds': '배치 타임아웃',
            'tier1_batch_size': 'Tier 1 배치', 'tier2_batch_size': 'Tier 2 배치',
            'tier1_prompt_version': 'Tier 1 프롬프트', 'tier2_prompt_version': 'Tier 2 프롬프트',
            'summary_mode': '요약 모드', 'tier2_summarize': 'Tier 2 요약',
            // sources
            'num_retries': '재시도 횟수', 'delay_seconds': '호출 간격(초)', 'max_results_per_query': '쿼리당 최대 수',
            'empty_page_retries': '빈 페이지 재시도', 'empty_page_backoff': '빈 페이지 대기(초)', 'window_buffer_minutes': '윈도우 여유(분)',
            // filter
            'pre_embed_cap': '최대 논문 수',
            // embedding
            'device': '연산 장치', 'optional': '선택적 실행', 'mode': '모드',
            // scoring
            'llm': 'AI 평가', 'embed': '유사도', 'recency': '최신성',
            'is_edge': '트렌드 보너스', 'is_realtime': '실시간 보너스', 'has_code': '코드 보너스',
            'default': '기본값', 'min_papers': '최소 논문 수', 'relaxation_steps': '완화 단계',
            'discard_cutoff': '제외 기준', 'max_output': '최대 출력', 'tier1_count': 'Tier 1 수',
            // remind
            'enabled': '활성화', 'min_score': '최소 점수', 'max_expose_count': '최대 재추천',
            // clustering
            'similarity_threshold': '유사도 기준',
            // output
            'keep_files': '파일 유지', 'retention_days': '보존 일수',
            'body_max_chars': '최대 글자수', 'labels': '라벨',
            // notifications
            'on_zero_results': '결과 없음 알림', 'on_error': '오류 알림',
            // database
            'path': '파일 경로', 'vacuum_after_purge': 'DB 최적화', 'papers_ttl_days': '논문 보존 일수',
            'evaluations_days': '평가 보존', 'query_stats_days': '통계 보존', 'runs_days': '실행 보존',
            'rolling_days': '보존 일수', 'dir': '저장 경로',
            'cache_key_prefix': '캐시 접두사', 'embed_cache_key_prefix': '임베딩 접두사',
            'keep_weeks': '보존 주수', 'name_template': '파일명 템플릿', 'connection_string_env': '환경변수명',
            // weekly
            'top_keywords': '키워드 수', 'top_papers': '논문 수',
            'updated_within_days': '업데이트 기간', 'published_min_days': '최소 경과일', 'published_max_days': '최대 경과일',
            // local_ui
            'host': '서버 주소', 'port': '포트',  'open_browser': '브라우저 열기',
        };

        // Render a single field input based on value type
        function renderField(name, value, label) {
            const escaped = String(value).replace(/"/g, '&quot;');
            const hint = FIELD_HINTS[name] || '';
            const hintHtml = hint ? `<small class="field-hint">${hint}</small>` : '';
            // Use Korean label if available
            label = FIELD_LABELS[label] || label;

            // Hide supabase_url and supabase_anon_key in read_sync section (managed in registration tab)
            if (name === 'read_sync.supabase_url' || name === 'read_sync.supabase_anon_key') {
                return '';
            }

            // Model priority inputs (1순위, 2순위, 3순위) - render all together from llm.model
            if (name === 'llm.model') {
                const escaped = String(value).replace(/"/g, '&quot;');
                let html = `<div class="mb-2"><label class="form-label">1순위 모델</label><small class="field-hint">${hint}</small><input type="text" class="form-control form-control-sm" name="llm.model" value="${escaped}" data-type="string" placeholder="예: deepseek/deepseek-r1-0528:free"></div>`;
                const arr = (window.currentSettings && window.currentSettings.llm && Array.isArray(window.currentSettings.llm.fallback_models)) ? window.currentSettings.llm.fallback_models : [];
                const slots = Math.max(arr.length, 2);
                for (let i = 0; i < slots; i++) {
                    const v = (arr[i] || '').replace(/"/g, '&quot;');
                    html += `<div class="mb-2"><label class="form-label">${i + 2}순위 모델</label><small class="field-hint">${i === 0 ? '1순위가 안 되면 순서대로 시도' : '비워두면 무시'}</small><input type="text" class="form-control form-control-sm" name="llm.fallback_models[]" value="${v}" data-type="fallback_model" placeholder="모델 ID를 붙여넣으세요"></div>`;
                }
                return html;
            }
            if (name === 'llm.fallback_models') {
                return ''; // already rendered above with llm.model
            }

            if (name.endsWith('.effort')) {
                const current = String(value || '').toLowerCase();
                const effortLabels = {low: 'low (낮음)', medium: 'medium (보통)', high: 'high (높음)'};
                const options = ['low', 'medium', 'high']
                    .map(opt => `<option value="${opt}" ${current === opt ? 'selected' : ''}>${effortLabels[opt]}</option>`)
                    .join('');
                return `<div class="mb-2"><label class="form-label">${label}</label>${hintHtml}<select class="form-select form-select-sm" name="${name}" data-type="string">${options}</select></div>`;
            }
            // formats, include_read_sync, notify_mode are now per-channel (send list)
            if (name === 'output.attachments.formats' ||
                name === 'output.attachments.include_read_sync' ||
                name === 'output.gh_pages.notify_mode') {
                return '';
            }
            if (name.endsWith('.summary_mode')) {
                const current = String(value || 'abstract').toLowerCase();
                const modeOptions = [
                    {value: 'abstract', label: 'Abstract (영문 초록 그대로)'},
                    {value: 'llm_ko', label: 'LLM 한국어 요약'}
                ].map(opt => `<option value="${opt.value}" ${current === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
                return `<div class="mb-2"><label class="form-label">${label}</label><small class="field-hint">abstract: 영문 초록 그대로 (비용 절감) / llm_ko: AI 한국어 요약</small><select class="form-select form-select-sm" name="${name}" data-type="string">${modeOptions}</select></div>`;
            }
            if (typeof value === 'boolean') {
                const checked = value ? 'checked' : '';
                return `<div class="form-check setting-bool"><input class="form-check-input" type="checkbox" name="${name}" ${checked} data-type="bool"><label class="form-check-label">${label}</label>${hintHtml}</div>`;
            } else if (typeof value === 'number') {
                const step = Number.isInteger(value) ? '1' : '0.01';
                return `<div class="mb-2"><label class="form-label">${label}</label>${hintHtml}<input type="number" step="${step}" class="form-control form-control-sm" name="${name}" value="${value}" data-type="number"></div>`;
            } else if (Array.isArray(value)) {
                const arrStr = JSON.stringify(value);
                return `<div class="mb-2"><label class="form-label">${label} <small class="text-muted">(JSON array)</small></label>${hintHtml}<input type="text" class="form-control form-control-sm" name="${name}" value='${arrStr.replace(/'/g, "&#39;")}' data-type="array"></div>`;
            } else {
                return `<div class="mb-2"><label class="form-label">${label}</label>${hintHtml}<input type="text" class="form-control form-control-sm" name="${name}" value="${escaped}" data-type="string"></div>`;
            }
        }

        // Render nested object fields recursively
        function renderObject(obj, prefix) {
            let html = '';
            for (const [key, value] of Object.entries(obj)) {
                const fullKey = prefix ? `${prefix}.${key}` : key;
                if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                    const nested = NESTED_LABELS[fullKey];
                    const displayName = nested ? nested[0] : key;
                    const nestedHint = nested ? `<span class="nested-hint">${nested[1]}</span>` : '';
                    html += `<div class="nested-group"><h6>${displayName}${nestedHint}</h6>`;
                    html += renderObject(value, fullKey);
                    html += '</div>';
                } else {
                    html += renderField(fullKey, value, key);
                }
            }
            return html;
        }

        // Load configuration settings
        async function loadSettings() {
            const container = document.getElementById('configEditor');

            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                window.currentSettings = settings;

                const SECTION_GROUPS = [
                    { label: '자주 바꾸는 설정', sections: ['app', 'llm', 'sources', 'scoring'] },
                    { label: '결과물 관리', sections: ['output', 'weekly', 'database', 'read_sync'] },
                    { label: '고급 설정', desc: '보통은 기본값 그대로 두면 됩니다.', sections: ['agents', 'filter', 'embedding', 'remind', 'clustering', 'local_ui'] },
                ];

                let html = '<form id="settingsForm">';
                for (const group of SECTION_GROUPS) {
                    html += `<div class="settings-group-header"><strong>${group.label}</strong>${group.desc ? `<span>${group.desc}</span>` : ''}</div>`;
                    for (const section of group.sections) {
                        const value = settings[section];
                        if (!value || typeof value !== 'object') continue;
                        const label = SECTION_LABELS[section] || section;
                        const desc = SECTION_DESCRIPTIONS[section] || '';
                        html += `<div class="settings-section" id="section-${section}">`;
                        const descHtml = desc ? `<span class="section-desc">${desc}</span>` : '';
                        html += `<div class="section-header" onclick="this.parentElement.classList.toggle('open')"><strong>${label}</strong>${descHtml}<span class="arrow">&#9654;</span></div>`;
                        html += `<div class="section-body">`;
                        html += renderObject(value, section);
                        html += '</div></div>';
                    }
                }
                html += '</form>';
                container.innerHTML = html;
                // saveSettingsBtn removed — handled by globalSave()
                // Bind format checkboxes to update hidden input
                document.querySelectorAll('.format-check').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const field = cb.dataset.field;
                        const checks = document.querySelectorAll(`.format-check[data-field="${field}"]`);
                        const vals = [];
                        checks.forEach(c => { if (c.checked) vals.push(c.value); });
                        const hidden = document.querySelector(`input[name="${field}"]`);
                        if (hidden) hidden.value = JSON.stringify(vals);
                    });
                });
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">설정 로딩 오류: ${error.message}</div>`;
            }
        }

        // Save configuration settings
        async function saveSettings() {
            const form = document.getElementById('settingsForm');
            const result = {};

            // Collect fallback models first (special handling)
            const fallbackModels = [];
            form.querySelectorAll('input[name="llm.fallback_models[]"]').forEach(input => {
                const v = input.value.trim();
                if (v) fallbackModels.push(v);
            });

            // Collect all editable controls
            form.querySelectorAll('input, select, textarea').forEach(control => {
                if (control.dataset.type === 'fallback_model') return; // handled above
                const parts = control.name.split('.');
                const dataType = control.dataset.type;
                let value;

                if (dataType === 'bool') {
                    value = control.checked;
                } else if (dataType === 'number') {
                    value = Number(control.value);
                } else if (dataType === 'array') {
                    try { value = JSON.parse(control.value); } catch { value = control.value; }
                } else {
                    value = control.value;
                }

                // Build nested object
                let current = result;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!current[parts[i]]) current[parts[i]] = {};
                    current = current[parts[i]];
                }
                current[parts[parts.length - 1]] = value;
            });

            // Inject fallback models array
            if (!result.llm) result.llm = {};
            result.llm.fallback_models = fallbackModels;

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result)
                });

                const data = await response.json();
                if (response.ok) {
                    loadSettings();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                throw error;
            }
        }

        // Deploy config to GitHub Actions secrets
        async function deployToGitHub() {
            const btn = document.getElementById('globalDeployBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '배포 중...';

            try {
                const response = await fetch('/api/setup/sync-actions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Use file_status for detailed change info
                    const raw = result.file_status || result.results || {};
                    const labelMap = {
                        'PAPER_SCOUT_CONFIG': '설정 파일 (config.yaml)',
                        'PAPER_SCOUT_KEYWORD_CACHE': '키워드 캐시',
                        'PAPER_SCOUT_LAST_SUCCESS': '마지막 실행 기록',
                        'PAPER_SCOUT_MODEL_CAPS': '모델 설정'
                    };
                    const statusIcon = (v) => {
                        const s = String(v);
                        if (s.includes('updated')) return '✅';
                        if (s.includes('unchanged')) return '⏩';
                        if (s.includes('skipped') || s.includes('not found')) return '⏭️';
                        if (s.startsWith('ok')) return '✅';
                        return '❌';
                    };
                    const statusDesc = (v) => {
                        const s = String(v);
                        if (s.includes('updated')) return '변경됨 → 업데이트 완료';
                        if (s.includes('unchanged')) return '변경 없음 (최신 상태)';
                        if (s.includes('not found')) return '파일 없음 (건너뜀)';
                        if (s.includes('skipped')) return '건너뜀';
                        if (s.startsWith('ok')) return '업데이트 완료';
                        return s;
                    };
                    const details = Object.entries(raw).map(([k, v]) => {
                        const label = labelMap[k] || k;
                        return `${statusIcon(v)} ${label}: ${statusDesc(v)}`;
                    }).join('\n');

                    const scheduleEnabled = window.currentSettings?.app?.schedule_enabled !== false;
                    const scheduleInfo = scheduleEnabled
                        ? '자동 실행: 매일 오전 11시 (KST)'
                        : '자동 실행: 비활성화됨';

                    alert(
                        'GitHub Actions 배포 완료\n\n'
                        + '[ 업데이트 항목 ]\n'
                        + details + '\n\n'
                        + '────────────────────────\n'
                        + scheduleInfo + '\n'
                        + '수동 실행: GitHub > Actions > Run workflow\n'
                        + '────────────────────────'
                    );
                } else if (result.error) {
                    alert(`배포 오류: ${result.error}\n\nGITHUB_TOKEN이 설정되어 있는지 확인해주세요.`);
                } else {
                    const rawErr = result.results || {};
                    const errors = Array.isArray(rawErr)
                        ? rawErr.filter(r => r.status !== 'ok').map(r => `${r.secret}: ${r.error || r.status}`).join('\n')
                        : Object.entries(rawErr).filter(([,v]) => !String(v).startsWith('ok')).map(([k,v]) => `${k}: ${v}`).join('\n');
                    alert('일부 항목 배포에 실패했습니다.\n\n' + (errors || result.error || 'Unknown error'));
                }
            } catch (error) {
                alert(`배포 오류: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Load environment status
        async function loadEnvStatus() {
            const container = document.getElementById('envStatus');
            if (!container) return;

            try {
                const response = await fetch('/api/settings/env-status');
                const status = await response.json();

                let html = '<table class="table table-sm"><thead><tr><th>이름</th><th>상태</th><th>마스킹 값</th><th>유효성</th></tr></thead><tbody>';
                for (const [key, value] of Object.entries(status)) {
                    const statusBadge = value.exists ? '<span class="badge bg-success">설정됨</span>' : '<span class="badge bg-secondary">미설정</span>';
                    const validBadge = value.exists ? (value.valid ? '<span class="badge bg-success">유효</span>' : '<span class="badge bg-warning">유효하지 않음</span>') : '<span class="badge bg-secondary">N/A</span>';
                    const maskedValue = value.masked_value || '-';

                    html += `
                        <tr>
                            <td>${key}</td>
                            <td>${statusBadge}</td>
                            <td><code>${maskedValue}</code></td>
                            <td>${validBadge}</td>
                        </tr>
                    `;
                }
                html += '</tbody></table>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">환경 변수 상태 로딩 오류: ${error.message}</div>`;
            }
        }

        // Load database and cache status
        async function loadDbStatus() {
            const container = document.getElementById('dbStatus');

            try {
                const response = await fetch('/api/settings/data-status');
                const status = await response.json();

                if (status.error) {
                    container.innerHTML = `<div class="alert alert-warning">데이터 상태를 불러올 수 없습니다: ${status.error}</div>`;
                    return;
                }

                let html = '';

                // DB connection warning
                if (status.db_error) {
                    html += `<div class="alert alert-warning py-2 small">DB 연결 실패: Supabase 연결 정보를 확인하세요. 아래는 로컬 정보만 표시됩니다.</div>`;
                }

                // DB overview
                html += '<h6>데이터베이스</h6>';
                html += `<p class="text-muted small mb-2"><code>${status.db_path}</code> (${status.db_size_mb} MB)</p>`;

                // DB tables
                html += '<table class="table table-sm table-hover mb-3">';
                html += '<thead><tr><th>테이블</th><th>설명</th><th>레코드</th><th></th></tr></thead><tbody>';
                for (const t of status.tables) {
                    const disabled = t.rows === 0 ? 'disabled' : '';
                    html += `<tr>
                        <td><code>${t.name}</code></td>
                        <td class="text-muted small">${t.description}</td>
                        <td><span class="badge ${t.rows > 0 ? 'bg-primary' : 'bg-secondary'}">${t.rows}</span></td>
                        <td><button class="btn btn-outline-danger btn-sm" ${disabled} onclick="resetTable('${t.name}')">초기화</button></td>
                    </tr>`;
                }
                html += '</tbody></table>';

                // DB full reset
                html += `<div class="d-flex justify-content-end mb-4">
                    <button class="btn btn-danger btn-sm" onclick="resetFullDb()" ${status.db_exists ? '' : 'disabled'}>DB 전체 삭제</button>
                </div>`;

                // Cache files
                html += '<h6>캐시 파일</h6>';
                html += '<table class="table table-sm table-hover">';
                html += '<thead><tr><th>파일</th><th>설명</th><th>크기</th><th></th></tr></thead><tbody>';
                for (const cf of status.cache_files) {
                    const badge = cf.exists
                        ? `<span class="badge bg-info">${cf.size_kb} KB</span>`
                        : '<span class="badge bg-secondary">없음</span>';
                    const disabled = cf.exists ? '' : 'disabled';
                    html += `<tr>
                        <td><code>${cf.name}</code></td>
                        <td class="text-muted small">${cf.description}</td>
                        <td>${badge}</td>
                        <td><button class="btn btn-outline-danger btn-sm" ${disabled} onclick="resetCache('${cf.path}', '${cf.name}')">삭제</button></td>
                    </tr>`;
                }
                html += '</tbody></table>';

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">데이터 상태 로딩 오류: ${error.message}</div>`;
            }
        }

        async function resetTable(tableName) {
            if (!confirm(`"${tableName}" 테이블의 모든 데이터를 삭제합니다.\n\n이 작업은 되돌릴 수 없습니다. 계속하시겠습니까?`)) return;

            try {
                const resp = await fetch('/api/settings/reset-table', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table: tableName })
                });
                const result = await resp.json();
                if (resp.ok) {
                    alert(`${tableName}: ${result.deleted}개 레코드 삭제 완료\n\nGitHub Actions에도 반영하려면 "GitHub 배포" 버튼을 눌러주세요.`);
                    loadDbStatus();
                } else {
                    alert(`오류: ${result.error}`);
                }
            } catch (e) {
                alert(`오류: ${e.message}`);
            }
        }

        async function resetCache(filePath, fileName) {
            if (!confirm(`"${fileName}" 파일을 삭제합니다.\n\n이 작업은 되돌릴 수 없습니다. 계속하시겠습니까?`)) return;

            try {
                const resp = await fetch('/api/settings/reset-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: filePath })
                });
                const result = await resp.json();
                if (resp.ok) {
                    alert(`${fileName} 삭제 완료\n\nGitHub Actions에도 반영하려면 "GitHub 배포" 버튼을 눌러주세요.`);
                    loadDbStatus();
                } else {
                    alert(`오류: ${result.error}`);
                }
            } catch (e) {
                alert(`오류: ${e.message}`);
            }
        }

        async function resetFullDb() {
            if (!confirm('데이터베이스 전체를 삭제합니다.\n\n모든 논문, 평가, 실행 기록이 삭제됩니다.\n이 작업은 되돌릴 수 없습니다. 계속하시겠습니까?')) return;
            if (!confirm('정말 삭제하시겠습니까? (최종 확인)')) return;

            try {
                const resp = await fetch('/api/settings/reset-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await resp.json();
                if (resp.ok) {
                    alert('데이터베이스가 삭제되었습니다.\n다음 파이프라인 실행 시 자동으로 재생성됩니다.\n\nGitHub Actions에도 반영하려면 "GitHub 배포" 버튼을 눌러주세요.');
                    loadDbStatus();
                } else {
                    alert(`오류: ${result.error}`);
                }
            } catch (e) {
                alert(`오류: ${e.message}`);
            }
        }

        // Bind refresh DB button
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('refreshDbBtn').onclick = loadDbStatus;
        });

        // Load topics for search dropdowns
        async function loadSearchTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();

                const dryrunSelect = document.getElementById('dryrunTopicSelect');
                const searchSelect = document.getElementById('searchTopicSelect');

                topics.forEach(topic => {
                    const option1 = document.createElement('option');
                    option1.value = topic.slug;
                    option1.textContent = topic.name;
                    dryrunSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = topic.slug;
                    option2.textContent = topic.name;
                    searchSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Error loading search topics:', error);
            }
        }

        // Step indicator management
        function markKeywordsReady() {
            // Step indicator removed — update notice only
            const notice = document.getElementById('keywordStatusNotice');
            if (notice) {
                notice.className = 'alert alert-success d-flex align-items-center mb-3';
                notice.style.fontSize = '0.9rem';
                notice.innerHTML = '<span style="font-size: 1.2rem; margin-right: 8px;">&#10003;</span><span>키워드가 준비되었습니다. 논문 검색을 시작할 수 있습니다.</span>';
            }
        }

        // Run dry-run with streaming
        let dryRunAbortController = null;

        function renderDryRunResults(result) {
            const resultsDiv = document.getElementById('dryrunResults');
            const resultsContent = document.getElementById('dryrunResultsContent');

            let html = '';
            for (const topic of result.topics) {
                if (topic.error) {
                    html += `<div class="alert alert-danger"><strong>${topic.slug}:</strong> ${topic.error}</div>`;
                    continue;
                }

                const topicId = topic.slug.replace(/[^a-zA-Z0-9]/g, '_');
                const excludeMode = topic.exclude_mode || 'soft';

                // Concepts as badge groups
                const conceptsHtml = topic.concepts.map(c => `
                    <div class="mb-2">
                        <span class="badge bg-primary me-1">${c.name_en}</span>
                        ${c.keywords.map(k => `<span class="badge bg-light text-dark border me-1">${k}</span>`).join('')}
                    </div>
                `).join('');

                // Cross-domain as badges
                const crossHtml = topic.cross_domain_keywords.map(k =>
                    `<span class="badge bg-info text-dark me-1 mb-1">${k}</span>`
                ).join('');

                // Query-must keywords as badges
                const mustQueryHtml = (topic.query_must_keywords || []).map(k =>
                    `<span class="badge bg-warning text-dark me-1 mb-1">${k}</span>`
                ).join('');

                // Exclude as badges
                const excludeHtml = topic.exclude_keywords.map(k =>
                    `<span class="badge bg-danger bg-opacity-75 me-1 mb-1">${k}</span>`
                ).join('');

                // Parse queries into phases by heuristic (broad→concept→cross→narrow)
                const queries = topic.queries;
                const totalQ = queries.length;
                // Split into 4 phases roughly
                const p1End = Math.ceil(totalQ * 0.35);
                const p2End = Math.ceil(totalQ * 0.60);
                const p3End = Math.ceil(totalQ * 0.80);
                const phases = [
                    { name: 'Broad', icon: '&#x1F310;', color: '#e0f2fe', queries: queries.slice(0, p1End) },
                    { name: 'Concept', icon: '&#x1F3AF;', color: '#fef3c7', queries: queries.slice(p1End, p2End) },
                    { name: 'Cross-domain', icon: '&#x1F517;', color: '#ede9fe', queries: queries.slice(p2End, p3End) },
                    { name: 'Narrow', icon: '&#x1F50D;', color: '#fce7f3', queries: queries.slice(p3End) },
                ];

                const queriesHtml = phases.filter(p => p.queries.length > 0).map(phase => `
                    <div class="mb-2">
                        <div class="d-flex align-items-center mb-1">
                            <span style="font-size: 0.9rem;">${phase.icon}</span>
                            <strong class="ms-1" style="font-size: 0.8rem;">${phase.name}</strong>
                            <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">${phase.queries.length}</span>
                        </div>
                        ${phase.queries.map(q => {
                            // Highlight arXiv operators
                            const highlighted = q
                                .replace(/\b(AND|OR|ANDNOT)\b/g, '<span style="color: #dc2626; font-weight: 600;">$1</span>')
                                .replace(/(cat:[^\s)]+)/g, '<span style="color: #2563eb;">$1</span>')
                                .replace(/(ti:|abs:|all:)/g, '<span style="color: #059669; font-weight: 600;">$1</span>');
                            return `<div style="background: ${phase.color}; border-radius: 6px; padding: 6px 10px; margin-bottom: 4px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.78rem; line-height: 1.4; word-break: break-all;">${highlighted}</div>`;
                        }).join('')}
                    </div>
                `).join('');

                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 d-inline">${topic.slug}</h6>
                                <span class="text-muted ms-2" style="font-size: 0.8rem;">
                                    ${topic.concepts.length} concepts &middot; ${totalQ} queries
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editKeywords('${topic.slug}')" title="키워드 편집">
                                    &#9998; 편집
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteKeywords('${topic.slug}')" title="캐시 삭제">
                                    &#128465; 삭제
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Keywords section -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <strong style="font-size: 0.9rem;">AI Keywords</strong>
                                </div>
                                ${conceptsHtml}

                                ${crossHtml ? `
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Cross-domain</small>
                                        ${crossHtml}
                                    </div>
                                ` : ''}

                                ${mustQueryHtml ? `
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Query Must Keywords</small>
                                        ${mustQueryHtml}
                                    </div>
                                ` : ''}

                                ${excludeHtml ? `
                                    <div class="mt-2">
                                        <small class="text-muted d-block mb-1">Exclude (${excludeMode})</small>
                                        ${excludeHtml}
                                    </div>
                                ` : ''}
                            </div>

                            <hr>

                            <!-- Queries section (collapsible, hidden by default) -->
                            <div>
                                <div class="d-flex justify-content-between align-items-center"
                                     style="cursor: pointer; user-select: none;"
                                     data-bs-toggle="collapse"
                                     data-bs-target="#queries_${topicId}"
                                     aria-expanded="false"
                                     aria-controls="queries_${topicId}">
                                    <div>
                                        <span class="query-toggle-arrow" style="display: inline-block; transition: transform 0.2s; transform: rotate(0deg); font-size: 0.7rem; margin-right: 4px;">&#9654;</span>
                                        <strong style="font-size: 0.9rem;">arXiv Queries</strong>
                                    </div>
                                    <span class="badge bg-primary">${totalQ}개</span>
                                </div>
                                <div class="collapse" id="queries_${topicId}">
                                    <div class="mt-2">${queriesHtml}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            resultsContent.innerHTML = html;
            resultsDiv.style.display = 'block';

            // Rotate arrow on query collapse toggle
            resultsContent.querySelectorAll('[data-bs-toggle="collapse"]').forEach(toggle => {
                const target = document.querySelector(toggle.getAttribute('data-bs-target'));
                if (target) {
                    const arrow = toggle.querySelector('.query-toggle-arrow');
                    target.addEventListener('show.bs.collapse', () => {
                        if (arrow) arrow.style.transform = 'rotate(90deg)';
                    });
                    target.addEventListener('hide.bs.collapse', () => {
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                    });
                }
            });
        }

        let dryRunElapsedTimer = null;
        let dryRunStartTime = null;
        let dryRunLogVisible = true;
        let dryRunLastProgress = 0;

        function startElapsedTimer() {
            dryRunStartTime = Date.now();
            const el = document.getElementById('dryrunElapsed');
            if (dryRunElapsedTimer) clearInterval(dryRunElapsedTimer);
            dryRunElapsedTimer = setInterval(() => {
                const sec = Math.floor((Date.now() - dryRunStartTime) / 1000);
                el.textContent = `(${sec}s)`;
            }, 1000);
        }

        function stopElapsedTimer() {
            if (dryRunElapsedTimer) {
                clearInterval(dryRunElapsedTimer);
                dryRunElapsedTimer = null;
            }
        }

        function setPulsingState(pulsing) {
            const container = document.getElementById('dryrunProgressContainer');
            if (pulsing) {
                container.classList.add('progress-pulsing');
            } else {
                container.classList.remove('progress-pulsing');
            }
        }

        function clearDryRunLog() {
            const logEl = document.getElementById('dryrunLog');
            if (logEl) logEl.innerHTML = '';
        }

        function toggleDryRunLog() {
            const container = document.getElementById('dryrunLog');
            const btn = document.getElementById('toggleDryRunLogBtn');
            dryRunLogVisible = !dryRunLogVisible;
            container.style.display = dryRunLogVisible ? 'block' : 'none';
            btn.innerHTML = dryRunLogVisible ? '&#9660; 상세 로그 접기' : '&#9654; 상세 로그 보기';
        }

        function formatDryRunStep(step) {
            const labels = {
                init: '초기화',
                llm_init: 'LLM 연결',
                keyword_cache: '키워드 캐시',
                keyword_expansion: '키워드 생성',
                keyword_done: '키워드 완료',
                query_building: '쿼리 생성',
                query_done: '쿼리 완료',
                complete: '완료'
            };
            return labels[step] || '진행';
        }

        function appendDryRunLog(message, step = '') {
            const logEl = document.getElementById('dryrunLog');
            if (!logEl || !message) return;

            const ts = new Date().toTimeString().slice(0, 8);
            const line = document.createElement('div');
            line.style.color = getLogLineColor(message, step);
            const stepPrefix = step ? `[${formatDryRunStep(step)}] ` : '';
            line.textContent = `[${ts}] ${stepPrefix}${message}`;
            logEl.appendChild(line);
            while (logEl.childElementCount > 200) {
                logEl.removeChild(logEl.firstChild);
            }
            logEl.scrollTop = logEl.scrollHeight;
        }

        function stopDryRun(completed = false) {
            if (dryRunAbortController) {
                dryRunAbortController.abort();
                dryRunAbortController = null;
            }
            stopElapsedTimer();
            setPulsingState(false);
            const btn = document.getElementById('runDryRunBtn');
            const cancelBtn = document.getElementById('cancelDryRunBtn');
            const rerunBtn = document.getElementById('rerunDryRunBtn');
            btn.disabled = false;
            btn.textContent = '키워드 생성';
            cancelBtn.style.display = 'none';
            rerunBtn.style.display = completed ? 'inline-block' : 'none';
        }

        document.getElementById('cancelDryRunBtn').addEventListener('click', () => {
            stopDryRun();
            document.getElementById('dryrunProgress').style.display = 'none';
            appendDryRunLog('사용자가 키워드 생성을 취소했습니다.', 'complete');
        });

        async function startDryRun(skipCache = false, preserveResults = false) {
            const topicSlug = document.getElementById('dryrunTopicSelect').value || '';
            const btn = document.getElementById('runDryRunBtn');
            const cancelBtn = document.getElementById('cancelDryRunBtn');
            const rerunBtn = document.getElementById('rerunDryRunBtn');
            const progressDiv = document.getElementById('dryrunProgress');
            const progressBar = document.getElementById('dryrunProgressBar');
            const progressMsg = document.getElementById('dryrunProgressMsg');
            const progressPct = document.getElementById('dryrunProgressPct');
            const resultsDiv = document.getElementById('dryrunResults');

            // Abort any previous stream
            if (dryRunAbortController) {
                dryRunAbortController.abort();
            }
            dryRunAbortController = new AbortController();

            btn.disabled = true;
            btn.textContent = '생성 중...';
            cancelBtn.style.display = 'inline-block';
            rerunBtn.style.display = 'none';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressMsg.textContent = '초기화 중...';
            progressPct.textContent = '0%';
            dryRunLastProgress = 0;
            document.getElementById('dryrunElapsed').textContent = '';
            clearDryRunLog();
            if (!dryRunLogVisible) toggleDryRunLog();
            appendDryRunLog(`키워드 생성 시작 (${topicSlug || '전체 토픽'})`, 'init');
            if (!preserveResults) {
                resultsDiv.style.display = 'none';
            }
            startElapsedTimer();

            const params = new URLSearchParams();
            if (topicSlug) params.set('topic_slug', topicSlug);
            if (skipCache) params.set('skip_cache', '1');
            const url = '/api/pipeline/dry-run-stream' + (params.toString() ? '?' + params.toString() : '');

            try {
                const response = await fetch(url, { signal: dryRunAbortController.signal });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // keep incomplete line

                    let currentEvent = '';
                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.substring(7).trim();
                        } else if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);

                                if (currentEvent === 'log') {
                                    const stepLabel = formatDryRunStep(data.step);
                                    progressMsg.textContent = `[${stepLabel}] ${data.message || ''}`;
                                    if (typeof data.progress === 'number') {
                                        dryRunLastProgress = Math.max(dryRunLastProgress, data.progress);
                                        progressBar.style.width = dryRunLastProgress + '%';
                                        progressPct.textContent = dryRunLastProgress + '%';
                                    }
                                    appendDryRunLog(data.message || '진행 업데이트', data.step || '');
                                    // Pulse during LLM call (keyword_expansion step)
                                    if (data.step === 'keyword_expansion') {
                                        setPulsingState(true);
                                    } else if (data.step === 'keyword_done' || data.step === 'keyword_cache') {
                                        setPulsingState(false);
                                    }
                                } else if (currentEvent === 'result') {
                                    renderDryRunResults(data);
                                    markKeywordsReady();
                                    appendDryRunLog('키워드 생성이 완료되었습니다.', 'complete');
                                    stopDryRun(true);
                                    return;
                                } else if (currentEvent === 'error') {
                                    const resultsContent = document.getElementById('dryrunResultsContent');
                                    resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
                                    resultsDiv.style.display = 'block';
                                    appendDryRunLog(`오류: ${data.message}`, 'error');
                                    stopDryRun(true);
                                    return;
                                }
                            } catch { /* ignore parse errors */ }
                        }
                    }
                }
                // Stream ended without result event
                stopDryRun(true);
            } catch (err) {
                if (err.name === 'AbortError') return; // cancelled by user
                const resultsContent = document.getElementById('dryrunResultsContent');
                resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
                resultsDiv.style.display = 'block';
                appendDryRunLog(`오류: ${err.message}`, 'error');
                stopDryRun(true);
            }
        }

        document.getElementById('runDryRunBtn').addEventListener('click', () => startDryRun(false));
        document.getElementById('rerunDryRunBtn').addEventListener('click', async () => {
            // Check if cache has manual edits
            const slug = document.getElementById('dryrunTopicSelect').value || '';
            if (slug) {
                try {
                    const resp = await fetch(`/api/pipeline/keywords/${slug}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.prompt_version === 'manual-edit') {
                            if (!confirm('수동 편집된 키워드가 있습니다. 캐시를 무시하면 LLM이 새로 생성하여 편집 내용이 사라집니다. 계속하시겠습니까?')) {
                                return;
                            }
                        }
                    }
                } catch { /* ignore */ }
            }
            startDryRun(true);
        });

        // Start search with progress bar
        function stopSearch(completed = false) {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            const btn = document.getElementById('startSearchBtn');
            const cancelBtn = document.getElementById('cancelSearchBtn');
            const rerunBtn = document.getElementById('rerunSearchBtn');
            btn.disabled = false;
            btn.textContent = '논문 검색 시작';
            cancelBtn.style.display = 'none';
            rerunBtn.style.display = completed ? 'inline-block' : 'none';
        }

        document.getElementById('cancelSearchBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/pipeline/cancel', { method: 'POST' });
            } catch (e) {
                console.warn('Cancel request failed:', e);
            }
            stopSearch();
            // Keep progress bar and log visible after cancel (don't hide searchProgress)
            const progressMsg = document.getElementById('searchProgressMsg');
            if (progressMsg) progressMsg.textContent = '취소 요청됨... 현재 단계 완료 후 중단됩니다.';
        });

        document.getElementById('resetPipelineBtn').addEventListener('click', async () => {
            if (!confirm('파이프라인 상태를 강제 초기화하시겠습니까?\n실행 중인 작업이 있으면 중단됩니다.')) return;
            try {
                const resp = await fetch('/api/pipeline/reset', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    stopSearch();
                    const progressDiv = document.getElementById('searchProgress');
                    if (progressDiv) progressDiv.style.display = 'none';
                    alert(data.message + (data.was_running ? ' (실행 중이던 작업이 초기화됨)' : ''));
                } else {
                    alert('초기화 실패: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('초기화 요청 실패: ' + e.message);
            }
        });

        async function startSearch() {
            const topicSlug = document.getElementById('searchTopicSelect').value || null;
            const dateFrom = document.getElementById('dateFrom').value || null;
            const dateTo = document.getElementById('dateTo').value || null;
            const dedup = document.querySelector('input[name="dedupMode"]:checked').value;

            const btn = document.getElementById('startSearchBtn');
            const cancelBtn = document.getElementById('cancelSearchBtn');
            const rerunBtn = document.getElementById('rerunSearchBtn');
            const progressDiv = document.getElementById('searchProgress');
            const progressBar = document.getElementById('searchProgressBar');
            const progressMsg = document.getElementById('searchProgressMsg');
            const progressPct = document.getElementById('searchProgressPct');
            const resultsDiv = document.getElementById('searchResults');

            btn.disabled = true;
            btn.textContent = '검색 중...';
            cancelBtn.style.display = 'inline-block';
            rerunBtn.style.display = 'none';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressMsg.textContent = '시작 중...';
            progressPct.textContent = '0%';
            resultsDiv.style.display = 'none';

            // Reset log state
            lastLogOffset = 0;
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';

            try {
                const response = await fetch('/api/pipeline/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic_slug: topicSlug,
                        date_from: dateFrom,
                        date_to: dateTo,
                        dedup: dedup
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || '파이프라인 시작 실패');
                }

                // Start polling
                startPolling();
            } catch (error) {
                const resultsContent = document.getElementById('searchResultsContent');
                resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
                stopSearch(true);
            }
        }

        document.getElementById('startSearchBtn').addEventListener('click', startSearch);
        document.getElementById('rerunSearchBtn').addEventListener('click', startSearch);

        // --- Weekly run button ---
        document.getElementById('weeklyRunBtn').addEventListener('click', async () => {
            const btn = document.getElementById('weeklyRunBtn');
            const progressDiv = document.getElementById('weeklyProgress');
            const progressMsg = document.getElementById('weeklyProgressMsg');

            btn.disabled = true;
            progressDiv.style.display = 'block';
            progressMsg.textContent = '데이터 확인 중...';

            try {
                // Pre-check: verify enough data exists
                const checkRes = await fetch('/api/pipeline/weekly-check');
                const checkData = await checkRes.json();

                if (!checkData.ready) {
                    if (!confirm(checkData.message + '\n\n그래도 위클리 리포트를 생성하시겠습니까?')) {
                        progressDiv.style.display = 'none';
                        btn.disabled = false;
                        return;
                    }
                }

                progressMsg.textContent = '위클리 파이프라인 실행 중...';

                const runRes = await fetch('/api/pipeline/weekly-run', { method: 'POST' });
                const runData = await runRes.json();

                if (!runRes.ok) {
                    alert(runData.error || '위클리 실행 요청 실패');
                    progressDiv.style.display = 'none';
                    btn.disabled = false;
                    return;
                }

                // Poll weekly status
                const weeklyPoll = setInterval(async () => {
                    try {
                        const statusRes = await fetch('/api/pipeline/weekly-status');
                        const statusData = await statusRes.json();

                        if (!statusData.running) {
                            clearInterval(weeklyPoll);
                            btn.disabled = false;
                            if (statusData.error) {
                                progressMsg.style.color = '#fca5a5';
                                progressMsg.textContent = '위클리 실행 실패: ' + statusData.error;
                            } else {
                                progressMsg.style.color = '#86efac';
                                progressMsg.textContent = '위클리 리포트 생성 완료!';
                                setTimeout(() => { progressDiv.style.display = 'none'; }, 5000);
                            }
                        }
                    } catch (e) {
                        clearInterval(weeklyPoll);
                        progressMsg.style.color = '#fca5a5';
                        progressMsg.textContent = '상태 확인 실패';
                        btn.disabled = false;
                    }
                }, 3000);

            } catch (e) {
                progressMsg.style.color = '#fca5a5';
                progressMsg.textContent = '위클리 실행 오류: ' + e.message;
                btn.disabled = false;
            }
        });

        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            pollInterval = setInterval(pollStatus, 2000);
            pollStatus();
        }

        async function pollStatus() {
            try {
                const response = await fetch('/api/pipeline/status');
                const status = await response.json();

                const progressBar = document.getElementById('searchProgressBar');
                const progressMsg = document.getElementById('searchProgressMsg');
                const progressPct = document.getElementById('searchProgressPct');
                const resultsDiv = document.getElementById('searchResults');
                const resultsContent = document.getElementById('searchResultsContent');

                // Calculate progress percentage using sub-step progress
                let pct = 0;
                if (status.topics_total > 0) {
                    const completedPct = (status.topics_completed / status.topics_total) * 100;
                    const currentStepPct = (status.step_progress || 0) / status.topics_total;
                    pct = Math.round(completedPct + currentStepPct);
                    pct = Math.min(pct, 99); // never show 100% until actually done
                }

                // Build status message with step name
                let msg = status.progress || '처리 중...';
                if (status.current_topic) {
                    const stepInfo = status.step_name ? ` - ${status.step_name}` : '';
                    msg = `${status.current_topic}${stepInfo} (${status.topics_completed + 1}/${status.topics_total})`;
                }

                progressBar.style.width = pct + '%';
                progressMsg.textContent = msg;
                progressPct.textContent = pct + '%';

                // Fetch logs incrementally
                fetchLogs();

                if (!status.running) {
                    if (status.error) {
                        resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${status.error}</div>`;
                    } else {
                        progressBar.style.width = '100%';
                        progressMsg.textContent = '완료!';
                        progressPct.textContent = '100%';
                        resultsContent.innerHTML = `
                            <div class="alert alert-success">
                                <strong>파이프라인 완료!</strong><br>
                                완료된 토픽: ${status.topics_completed}개<br>
                                <a href="/reports" target="_blank" class="btn btn-sm btn-primary mt-2">리포트 보기</a>
                            </div>
                        `;
                    }
                    resultsDiv.style.display = 'block';
                    // Final log fetch to get any remaining lines
                    fetchLogs();
                    stopSearch(true);
                }
            } catch (error) {
                console.error('Error polling status:', error);
            }
        }
        // ==========================================
        // Keyword Edit Functions
        // ==========================================
        let _currentEditSlug = null;

        async function editKeywords(slug) {
            _currentEditSlug = slug;
            try {
                const resp = await fetch(`/api/pipeline/keywords/${slug}`);
                if (!resp.ok) {
                    alert(resp.status === 404 ? '캐시된 키워드가 없습니다. Dry-run을 먼저 실행하세요.' : '키워드 로드 실패');
                    return;
                }
                const data = await resp.json();
                const kw = data.result;

                // Populate the edit form
                document.getElementById('editSlugLabel').textContent = slug;

                // Concepts -> editable textarea (JSON)
                const conceptsText = kw.concepts.map(c =>
                    `${c.name_en}: ${c.keywords.join(', ')}`
                ).join('\n');
                document.getElementById('editConcepts').value = conceptsText;

                // Cross-domain keywords
                document.getElementById('editCrossDomain').value = kw.cross_domain_keywords.join(', ');

                // Must-include query keywords (optional)
                document.getElementById('editMustQuery').value = (kw.query_must_keywords || []).join(', ');

                // Exclude keywords
                document.getElementById('editExclude').value = kw.exclude_keywords.join(', ');
                document.getElementById('editExcludeMode').value = kw.exclude_mode || 'soft';

                // Embedding text
                document.getElementById('editEmbedding').value = kw.topic_embedding_text || '';

                // Store original data for structure reference
                document.getElementById('editConcepts').dataset.original = JSON.stringify(kw.concepts);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('keywordEditModal'));
                modal.show();
            } catch (err) {
                alert('키워드 로드 오류: ' + err.message);
            }
        }

        async function saveKeywords() {
            const slug = _currentEditSlug;
            if (!slug) return;

            // Parse concepts from text format
            const conceptsRaw = document.getElementById('editConcepts').value.trim();
            const originalConcepts = JSON.parse(document.getElementById('editConcepts').dataset.original || '[]');
            const concepts = [];

            for (const line of conceptsRaw.split('\n')) {
                if (!line.trim()) continue;
                const colonIdx = line.indexOf(':');
                const fullWidthColonIdx = line.indexOf('：');
                const sepIdx = colonIdx !== -1 ? colonIdx : fullWidthColonIdx;
                if (sepIdx === -1) continue;
                const nameEn = line.substring(0, sepIdx).trim();
                const keywords = line.substring(sepIdx + 1).split(',').map(k => k.trim()).filter(k => k);
                if (!nameEn || keywords.length === 0) continue;
                // Try to find original name_ko
                const orig = originalConcepts.find(c => c.name_en === nameEn);
                concepts.push({
                    name_ko: orig ? orig.name_ko : nameEn,
                    name_en: nameEn,
                    keywords: keywords
                });
            }

            const crossDomain = document.getElementById('editCrossDomain').value
                .split(',').map(k => k.trim()).filter(k => k);
            const mustQueryKeywords = document.getElementById('editMustQuery').value
                .split(/[\n,]/).map(k => k.trim()).filter(k => k);
            const exclude = document.getElementById('editExclude').value
                .split(',').map(k => k.trim()).filter(k => k);
            const excludeMode = document.getElementById('editExcludeMode').value || 'soft';
            const embedding = document.getElementById('editEmbedding').value.trim();

            if (concepts.length === 0) {
                alert('최소 1개 이상의 컨셉이 필요합니다.');
                return;
            }

            const body = {
                concepts,
                cross_domain_keywords: crossDomain,
                query_must_keywords: mustQueryKeywords,
                exclude_keywords: exclude,
                exclude_mode: excludeMode,
                topic_embedding_text: embedding
            };

            try {
                const resp = await fetch(`/api/pipeline/keywords/${slug}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await resp.json();
                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('keywordEditModal')).hide();
                    // Auto-run dry-run with cache (uses edited keywords)
                    document.getElementById('dryrunTopicSelect').value = slug;
                    startDryRun(false, true); // keep previous query list visible
                } else {
                    alert('저장 실패: ' + (result.error || JSON.stringify(result)));
                }
            } catch (err) {
                alert('저장 오류: ' + err.message);
            }
        }

        async function deleteKeywords(slug) {
            if (!confirm(`"${slug}" 토픽의 캐시된 키워드를 삭제하시겠습니까?\n다음 Dry-run 시 LLM이 새로 생성합니다.`)) return;
            try {
                const resp = await fetch(`/api/pipeline/keywords/${slug}`, { method: 'DELETE' });
                if (resp.ok) {
                    alert('키워드 캐시가 삭제되었습니다.');
                    document.getElementById('dryrunResults').style.display = 'none';
                } else {
                    const data = await resp.json();
                    alert('삭제 실패: ' + (data.error || ''));
                }
            } catch (err) {
                alert('삭제 오류: ' + err.message);
            }
        }
    </script>

    <!-- Keyword Edit Modal -->
    <div class="modal fade" id="keywordEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">키워드 편집 - <span id="editSlugLabel"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Concepts</label>
                        <small class="text-muted d-block mb-1">한 줄에 하나씩: <code>Concept Name: keyword1, keyword2, keyword3</code></small>
                        <textarea class="form-control font-monospace" id="editConcepts" rows="10" style="font-size: 0.85rem;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cross-domain Keywords</label>
                        <small class="text-muted d-block mb-1">쉼표로 구분</small>
                        <textarea class="form-control font-monospace" id="editCrossDomain" rows="3" style="font-size: 0.85rem;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Query Must Keywords</label>
                        <small class="text-muted d-block mb-1">쉼표 또는 줄바꿈으로 구분 (이 키워드는 쿼리에 우선 포함)</small>
                        <textarea class="form-control font-monospace" id="editMustQuery" rows="2" style="font-size: 0.85rem;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Exclude Keywords</label>
                        <small class="text-muted d-block mb-1">쉼표로 구분 (이 키워드가 포함된 논문은 검색에서 제외됩니다)</small>
                        <textarea class="form-control font-monospace" id="editExclude" rows="3" style="font-size: 0.85rem;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Exclude Mode</label>
                        <small class="text-muted d-block mb-1">`soft`: 관련 키워드가 함께 있으면 유지, `strict`: 쿼리 단계에서 즉시 제외</small>
                        <select class="form-select" id="editExcludeMode">
                            <option value="soft">soft (권장)</option>
                            <option value="strict">strict</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Embedding Text</label>
                        <small class="text-muted d-block mb-1">논문과의 유사도 매칭에 사용되는 텍스트</small>
                        <textarea class="form-control font-monospace" id="editEmbedding" rows="3" style="font-size: 0.85rem;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveKeywords()">저장</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
