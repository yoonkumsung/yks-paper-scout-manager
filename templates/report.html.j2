{% extends "base.html.j2" %}

{% block title %}{{ meta.display_title }}{% endblock %}

{% block content %}
<div class="header">
  <h1>{{ meta.display_title }}</h1>
  <div class="stats">
    <span>수집 {{ meta.total_collected }}편</span>
    <span>필터 {{ meta.total_filtered }}편</span>
    <span>제외 {{ meta.total_discarded }}편</span>
    <span>선정 {{ meta.total_output }}편</span>
  </div>
  <div class="window-info">
    <span class="window-label">검색 윈도우</span>
    <span class="window-range">{{ meta.window_start_utc | window_date }}</span>
    <span class="window-sep">~</span>
    <span class="window-range">{{ meta.window_end_utc | window_date }}</span>
  </div>
</div>

{% if meta.keywords_used %}
<details>
  <summary>검색 키워드</summary>
  <div class="details-content">
    {{ meta.keywords_used | join(", ") }}
  </div>
</details>
{% endif %}

<div class="tabs">
  <input type="radio" name="tabs" id="tab-today" checked>
  <input type="radio" name="tabs" id="tab-remind">
  <input type="radio" name="tabs" id="tab-excluded">
  <div class="tab-labels">
    <label for="tab-today">오늘의 논문</label>
    <label for="tab-remind">다시 보기</label>
    <label for="tab-excluded">제외된 논문 ({{ discarded_papers | length }})</label>
  </div>

  <div class="tab-content tab-panel-today">
    {% if papers %}
      {% set tier1_papers = [] %}
      {% set tier2_papers = [] %}
      {% for paper in papers %}
        {% if paper.tier == 1 %}
          {% if tier1_papers.append(paper) %}{% endif %}
        {% else %}
          {% if tier2_papers.append(paper) %}{% endif %}
        {% endif %}
      {% endfor %}

      {% for paper in tier1_papers %}
      <div class="paper-card">
        <div class="rank-title">
          <input type="checkbox" class="paper-checkbox" data-tier="1" data-pdf="{{ paper.pdf_url or '' }}" onchange="updateToolbar()">
          <span class="rank">{{ paper.rank }}위</span>
          <span class="paper-title">
            <a href="{{ paper.url }}">{{ paper.title }}</a>
          </span>
          {% if paper.score_lowered %}
          <span class="lowered-tag">[완화]</span>
          {% endif %}
        </div>

        <div class="score-bar-container">
          <span>{{ paper.final_score }}</span>
          <div class="score-bar">
            <div class="score-bar-fill" style="width: {{ paper.final_score }}%"></div>
          </div>
          <span class="score-detail">
            base:{{ paper.llm_base_score }} + bonus:+{{ paper.bonus_score }}
          </span>
        </div>

        {% if paper.categories %}
        <div class="categories">
          {% for cat in paper.categories %}
          <span class="cat-tag">{{ cat }}</span>
          {% endfor %}
        </div>
        {% endif %}

        {% set flags = paper.flags | default({}) %}
        {% if flags or paper.has_code %}
        <div class="flags">
          {% if flags.is_edge %}
          <span class="flag-tag flag-edge">엣지</span>
          {% endif %}
          {% if flags.is_realtime %}
          <span class="flag-tag flag-realtime">실시간</span>
          {% endif %}
          {% if paper.has_code %}
          <span class="flag-tag flag-code">코드</span>
          {% endif %}
        </div>
        {% endif %}

        {% if paper.summary_ko %}
        <details>
          <summary>개요</summary>
          <div class="details-content">{{ paper.summary_ko }}</div>
        </details>
        {% endif %}

        {% if paper.reason_ko %}
        <p><strong>선정 근거:</strong> {{ paper.reason_ko }}</p>
        {% endif %}

        {% if paper.insight_ko %}
        <p><strong>활용 인사이트:</strong> {{ paper.insight_ko }}</p>
        {% endif %}

        <div class="paper-links">
          {% if paper.pdf_url %}
          <a href="{{ paper.pdf_url }}">PDF</a>
          {% endif %}
          {% if paper.has_code and paper.code_url %}
          <a href="{{ paper.code_url }}">Code</a>
          {% endif %}
        </div>

        {% if paper.cluster_mates %}
        <div class="cluster-links">
          같은 클러스터: {{ paper.cluster_mates | join(", ") }}
        </div>
        {% endif %}
      </div>
      {% endfor %}

      {% if tier1_papers and tier2_papers %}
      <div class="tier-divider">Tier 2</div>
      {% endif %}

      {% for paper in tier2_papers %}
      <div class="compact-card">
        <div class="rank-title">
          <input type="checkbox" class="paper-checkbox" data-tier="2" data-pdf="{{ paper.pdf_url or '' }}" onchange="updateToolbar()">
          <span class="rank">{{ paper.rank }}위</span>
          <span class="paper-title">
            <a href="{{ paper.url }}">{{ paper.title }}</a>
          </span>
          {% if paper.score_lowered %}
          <span class="lowered-tag">[완화]</span>
          {% endif %}
          <span class="compact-meta">
            <span class="score-detail">{{ paper.final_score }}</span>
            {% if paper.pdf_url %}
            <a href="{{ paper.pdf_url }}" class="compact-link">PDF</a>
            {% endif %}
          </span>
        </div>
        {% if paper.summary_ko %}
        <div class="compact-body">
          <span class="abstract-preview">{{ paper.summary_ko | truncate_sentences(2) }}</span>
          {% if paper.summary_ko | truncate_sentences(2) != paper.summary_ko %}
          <details class="abstract-full">
            <summary>more</summary>
            <div class="details-content">{{ paper.summary_ko }}</div>
          </details>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-message">
        오늘은 새로운 논문이 없습니다.
      </div>
    {% endif %}
  </div>

  <div class="tab-content tab-panel-remind">
    {% if remind_papers %}
      {% for paper in remind_papers %}
      <div class="remind-card">
        <div class="rank-title">
          <span class="paper-title">
            <a href="{{ paper.url }}">{{ paper.title }}</a>
          </span>
          <span class="recommend-count">{{ paper.recommend_count | default(1) }}회째 추천</span>
        </div>
        <div class="score-bar-container">
          <span>{{ paper.final_score }}</span>
        </div>
        {% if paper.summary_ko %}
        <p>{{ paper.summary_ko }}</p>
        {% endif %}
        {% if paper.reason_ko %}
        <p><strong>선정 근거:</strong> {{ paper.reason_ko }}</p>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-message">
        다시 보기 논문이 없습니다.
      </div>
    {% endif %}
  </div>

  <div class="tab-content tab-panel-excluded">
    {% if discarded_papers %}
      {% for paper in discarded_papers %}
      <div class="discarded-card">
        <div class="paper-title">
          {% if paper.url %}<a href="{{ paper.url }}">{{ paper.title }}</a>{% else %}{{ paper.title }}{% endif %}
        </div>
        {% if paper.reason %}
        <div class="discard-reason">제외 사유: {{ paper.reason }}</div>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-message">
        제외된 논문이 없습니다.
      </div>
    {% endif %}
  </div>
</div>

<div class="download-toolbar" id="downloadToolbar">
  <div class="toolbar-selects">
    <button class="toolbar-btn" onclick="toggleSelect('all')">All</button>
    <button class="toolbar-btn" onclick="toggleSelect('tier1')">Tier 1</button>
    <button class="toolbar-btn" onclick="toggleSelect('tier2')">Tier 2</button>
    <button class="toolbar-btn" onclick="toggleSelect('none')">Deselect</button>
  </div>
  <button class="toolbar-btn primary" id="downloadBtn" onclick="downloadSelected()">Download 0 PDFs</button>
</div>

<footer>
  <p>이 리포트는 arXiv API를 사용하여 생성되었습니다.</p>
  <p>arXiv 논문의 저작권은 각 저자에게 있습니다.</p>
  <p>Thank you to arXiv for use of its open access interoperability.</p>
  <p>run_id: {{ meta.run_id }} | embedding: {{ meta.embedding_mode }}
    | weights: {{ meta.scoring_weights }}</p>
</footer>

<script>
function toggleSelect(filter) {
  var boxes = document.querySelectorAll('.tab-panel-today .paper-checkbox');
  boxes.forEach(function(cb) {
    if (filter === 'none') { cb.checked = false; }
    else if (filter === 'all') { cb.checked = true; }
    else if (filter === 'tier1') { cb.checked = cb.dataset.tier === '1'; }
    else if (filter === 'tier2') { cb.checked = cb.dataset.tier === '2'; }
  });
  updateToolbar();
}

function updateToolbar() {
  var checked = document.querySelectorAll('.paper-checkbox:checked');
  var toolbar = document.getElementById('downloadToolbar');
  var btn = document.getElementById('downloadBtn');
  var count = 0;
  checked.forEach(function(cb) { if (cb.dataset.pdf) count++; });
  if (checked.length > 0) {
    toolbar.classList.add('visible');
    document.body.classList.add('toolbar-active');
    btn.textContent = 'Download ' + count + ' PDFs';
    btn.disabled = (count === 0);
  } else {
    toolbar.classList.remove('visible');
    document.body.classList.remove('toolbar-active');
  }
}

function downloadSelected() {
  var checked = document.querySelectorAll('.paper-checkbox:checked');
  var urls = [];
  checked.forEach(function(cb) { if (cb.dataset.pdf) urls.push(cb.dataset.pdf); });
  if (urls.length === 0) return;
  urls.forEach(function(url, i) {
    setTimeout(function() { window.open(url, '_blank'); }, i * 300);
  });
}
</script>
{% endblock %}
